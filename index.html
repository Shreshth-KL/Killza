<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Killza Tournament - Best Organisation</title>

    <!-- Icons and Fonts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;77&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@500&display=swap" rel="stylesheet">
    <!-- Swiper CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* --- FINAL: Color Palettes --- */
        :root {
            /* Base Colors (Dark Theme) */
            --primary-bg: #10011a;
            --secondary-bg: #1c0d2e;
            --card-bg: #1c0d2e;
            --text-primary: #f0e8ff;
            --text-secondary: #a797c2;
            --border-color: #3a2a57;
            --bottom-nav-bg: #1c0d2e;
            --success-color: #10B981;
            --danger-color: #EF4444;
            --warning-color: #F59E0B;
            --info-color: #3B82F6;
            --transition-speed: 0.3s;
            
            /* Dynamic Accent Color Variable */
            --dynamic-accent: #ff8c00; /* Default to Killza's orange */
            --dynamic-gradient: linear-gradient(90deg, #ff8c00, #ff0080, #8a2be2);
        }
        
        body.light-theme {
            --primary-bg: #ffffff;
            --secondary-bg: #f6f8fa;
            --card-bg: #ffffff;
            --text-primary: #24292f;
            --text-secondary: #57606a;
            --border-color: #d0d7de;
            --bottom-nav-bg: #ffffff;
            --dynamic-accent: #0969da; /* Blue for light theme */
            --dynamic-gradient: linear-gradient(90deg, #0969da, #579aff);
            background: var(--primary-bg);
            animation: none;
        }

        body.dark-theme {
            --primary-bg: #0d1117;
            --secondary-bg: #161b22;
            --card-bg: #161b22;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --border-color: #30363d;
            --bottom-nav-bg: #161b22;
            --dynamic-accent: #58a6ff; /* Blue for dark theme */
            --dynamic-gradient: linear-gradient(90deg, #1f6feb, #2d96ff, #58a6ff);
        }
        
        body.killza-theme {
            --primary-bg: #10011a; 
            --secondary-bg: rgba(28, 13, 46, 0.6);
            --card-bg: rgba(28, 13, 46, 0.5);
            --text-primary: #f0e8ff;
            --text-secondary: #a797c2;
            --border-color: rgba(58, 42, 87, 0.5);
            --bottom-nav-bg: rgba(28, 13, 46, 0.7);
            --dynamic-accent: #ff8c00;
            --dynamic-gradient: linear-gradient(90deg, #ff8c00, #ff0080, #8a2be2);

            background: linear-gradient(135deg, #3d0f0f, #3a0f3d, #0f0f3d, #0f3d3d);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { font-size: 16px; }
        body {
            font-family: 'Poppins', sans-serif;
            color: var(--text-primary);
            padding-top: 60px; padding-bottom: 65px;
            min-height: 100vh;
            overscroll-behavior-y: contain;
            background: var(--primary-bg);
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }

        .app-header, .bottom-nav, .auth-modal-content, .custom-modal-content, .tournament-card, .wallet-card-new, .profile-links .list-group, .earnings-box, .section, .form-control {
            transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeInSlideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .animated-item { opacity: 0; animation: fadeInSlideUp 0.5s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; }
        
        body.killza-theme .app-header, body.killza-theme .bottom-nav, body.killza-theme .card,
        body.killza-theme .tournament-card, body.killza-theme .wallet-card-new, body.killza-theme .earnings-box,
        body.killza-theme .profile-links .list-group, body.killza-theme .modal-content,
        body.killza-theme .custom-modal-content, body.killza-theme .notification-panel {
            -webkit-backdrop-filter: blur(10px); backdrop-filter: blur(10px);
        }

        a { color: var(--dynamic-accent); text-decoration: none; transition: filter var(--transition-speed) ease; }
        a:hover { filter: brightness(1.2); }
        .main-content { padding: 15px; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.4s ease; }
        
        #login-section { padding: 0; height: calc(100vh - 60px - 65px); text-align: center; margin-top: -60px; }
        #login-section.active { display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .welcome-container { padding: 20px; }
        .welcome-title { font-size: 2.5rem; font-weight: 700; color: #fff; margin-bottom: 1rem; text-shadow: 0 0 10px rgba(255, 255, 255, 0.2); line-height: 1.2; }
        .welcome-title span{ background: var(--dynamic-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .welcome-subtitle { font-size: 1rem; color: var(--text-secondary); margin-bottom: 2.5rem; max-width: 400px; }
        .welcome-actions .btn { width: 100%; max-width: 300px; padding: 12px 20px; font-size: 1rem; font-weight: 600; border-radius: 50px; border: none; margin-bottom: 1rem; transition: transform var(--transition-speed) ease, background-position var(--transition-speed) ease; }
        .btn-login-main { background: var(--dynamic-gradient); background-size: 200% auto; color: white; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }
        .btn-login-main:hover { background-position: right center; transform: scale(1.05); }
        .btn-create-main { background-color: transparent; color: var(--text-primary); border: 2px solid var(--border-color); }
        .btn-create-main:hover { background-color: var(--border-color); transform: scale(1.05); }
        .welcome-footer { position: absolute; bottom: 80px; left: 0; width: 100%; text-align: center; font-size: 0.8rem; color: var(--text-secondary); }
        .welcome-footer a { color: var(--text-secondary); margin: 0 10px; }
        .auth-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(16, 1, 26, 0.8); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 1050; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity var(--transition-speed) ease; }
        .auth-modal-overlay.visible { display: flex; opacity: 1; }
        .auth-modal-content { background: var(--secondary-bg); padding: 2rem; border-radius: 15px; border: 1px solid var(--border-color); width: 90%; max-width: 400px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: translateY(20px) scale(0.95); opacity: 0; transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .auth-modal-overlay.visible .auth-modal-content { transform: translateY(0) scale(1); opacity: 1; }
        .auth-modal-close { position: absolute; top: 10px; right: 15px; background: none; border: none; color: var(--text-secondary); font-size: 1.8rem; cursor: pointer; }
        .auth-modal-title { text-align: center; font-size: 1.8rem; font-weight: 600; margin-bottom: 1.5rem; color:var(--text-primary); }
        .auth-modal-content .form-label { color: var(--text-secondary); font-size: 0.9rem; }
        .auth-modal-content .form-control { background-color: var(--primary-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; padding: 10px; }
        .auth-modal-content .form-control:focus { background-color: var(--primary-bg); border-color: var(--dynamic-accent); color: var(--text-primary); box-shadow: 0 0 0 0.2rem rgba(255, 140, 0, 0.25); }
        .btn-custom { border-radius: 8px; font-size: 1rem; font-weight: 500; padding: 10px 15px; border: none; background: var(--dynamic-gradient); background-size: 200% auto; color: white; transition: background-position var(--transition-speed) ease, transform var(--transition-speed) ease, filter var(--transition-speed) ease; }
        .btn-custom:hover { background-position: right center; transform: translateY(-2px); filter: brightness(1.1); }
        .btn-custom:active { transform: translateY(0px) scale(0.98); filter: brightness(0.95); }
        .auth-modal-content .btn-custom-link { background: none; border: none; color: var(--dynamic-accent); font-size: 0.9rem; padding: 5px; cursor: pointer; }

        .section-title { font-family: 'Oswald', sans-serif; font-size: 1.5rem; font-weight: 500; margin-bottom: 20px; color: var(--text-primary); text-transform: uppercase; letter-spacing: 1px; text-align: left; }
        #globalLoaderEl { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 9999; display: none; }
        .spinner-border { color: var(--dynamic-accent); width: 3rem; height: 3rem; }
        .app-header { position: fixed; top: 0; left: 0; width: 100%; height: 60px; background-color: var(--secondary-bg); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); z-index: 1000; border-bottom: 1px solid var(--border-color); } .header-left { display: flex; align-items: center; gap: 10px; } .header-logo { width: 40px; height: 40px; border-radius: 50%; background-color: #fff; object-fit: cover; border: 1px solid var(--dynamic-accent); }
        .header-title { font-family: 'Oswald', sans-serif; font-size: 1.4rem; font-weight: 600; line-height: 1; padding-left: 5px; flex-shrink: 0; display: flex; align-items: baseline; gap: 8px; }
        /* --- FINAL FIX for Brand Name Color --- */
        .header-brand-name { background: linear-gradient(90deg, #ff8c00, #ff0080); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; text-transform: uppercase; }
        #headerUserGreetingEl { color: var(--text-primary); font-size: 1.1rem; font-weight: 500; text-transform: none; -webkit-text-fill-color: var(--text-primary); }
        .header-back-button { background: none; border: none; color: var(--text-primary); font-size: 1.4rem; margin-right: 5px; display: none; padding: 5px; } .header-right { display: flex; align-items: center; gap: 15px; } .notification-icon { font-size: 1.3rem; color: var(--text-primary); position: relative; background: none; border: none; padding: 0; } .notification-badge { position: absolute; top: -3px; right: -5px; background-color: var(--danger-color); color: white; font-size: 0.6rem; width: 15px; height: 15px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; } .wallet-chip { background: var(--dynamic-gradient); background-size: 200%; color: #fff; padding: 5px 12px; border-radius: 20px; display: flex; align-items: center; font-size: 0.85rem; font-weight: 700; border: none; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2); cursor: pointer; transition: transform var(--transition-speed) ease; } .wallet-chip:hover { transform: scale(1.05); } .wallet-chip i { margin-right: 5px; font-size: 0.9rem; } .header-game-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin-left: 10px; display: none; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background-color: var(--bottom-nav-bg); display: flex; justify-content: space-around; align-items: stretch; box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2); z-index: 1000; border-top: 1px solid var(--border-color); } .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); text-decoration: none; flex-grow: 1; padding: 8px 0; transition: color var(--transition-speed) ease, background-color var(--transition-speed) ease, transform var(--transition-speed) ease; border: none; background: none; cursor: pointer; font-size: 0.7rem; } .nav-item:active { transform: scale(0.95); } .nav-item i { font-size: 1.4rem; margin-bottom: 4px; line-height: 1; } .nav-item span { font-size: 0.7rem; font-weight: 500; line-height: 1; } .nav-item.active { color: var(--dynamic-accent); background-color: rgba(255, 140, 0, 0.1); transform: translateY(-3px); }
        .game-card { position: relative; text-align: center; background-color: var(--card-bg); border-radius: 8px; overflow: hidden; padding: 0; border: 1px solid var(--border-color); cursor: pointer; transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease; } .game-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); } .game-card img { width: 100%; height: 130px; object-fit: cover; display: block; } .game-card span { display: block; padding: 10px 5px; font-weight: 500; font-size: 0.9rem; color: var(--text-primary); }
        .game-tournament-count { position: absolute; top: 8px; right: 8px; background-color: var(--info-color); color: white; font-size: 0.75rem; font-weight: 700; padding: 3px 8px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        
        /* --- FINAL FIX: Tournament Tab Styles --- */
        .tournament-tabs { display: flex; justify-content: space-around; background-color: var(--secondary-bg); padding: 5px; border-radius: 8px; margin-bottom: 15px; } 
        .tab-item { color: var(--text-secondary); background: none; border: none; padding: 8px 10px; font-size: 0.85rem; font-weight: 600; border-radius: 6px; flex-grow: 1; text-align: center; cursor: pointer; transition: color var(--transition-speed) ease, background-color var(--transition-speed) ease; } 
        .tab-item.active { background-color: var(--dynamic-accent); color: #fff; /* Use dynamic accent color for active tab */ } 
        .tab-item i { margin-right: 5px; }

        .tournament-card { background-color: var(--card-bg); border-radius: 12px; margin-bottom: 20px; overflow: hidden; border: 1px solid var(--border-color); cursor: pointer; transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
        .tournament-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.25); }
        .tournament-card .card-header-image { width: 100%; height: 160px; object-fit: cover; display: block; background-color: var(--primary-bg); }
        .tournament-card .card-content { padding: 15px; }
        .tournament-card .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .tournament-card .info-box { background-color: var(--primary-bg); border-radius: 8px; padding: 8px 5px; text-align: center; }
        .tournament-card .info-box span { font-size: 0.7rem; color: var(--text-secondary); display: block; margin-bottom: 2px; text-transform: uppercase; }
        .tournament-card .info-box strong { font-size: 0.9rem; color: var(--text-primary); }
        .tournament-card .card-title { font-size: 1.1rem; font-weight: 600; margin: 0; color: var(--text-primary); }
        .tournament-card .card-time { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 15px; }
        .tournament-card .spots-text { font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; }
        .tournament-card .spots-text strong { color: var(--text-primary); }
        .tournament-card .progress { height: 8px; background-color: var(--primary-bg); border-radius: 4px; width: 100%; overflow: hidden; }
        .tournament-card .progress-bar { background: var(--dynamic-gradient); }
        .tournament-card .btn-join { width: 100%; padding: 10px; font-size: 1rem; font-weight: 600; border: none; border-radius: 8px; background: var(--info-color); color: #fff; margin-top: 15px; cursor: pointer; transition: background-color var(--transition-speed) ease, transform var(--transition-speed) ease; }
        .tournament-card .btn-join:hover:not(:disabled) { background-color: #4b8df1; transform: scale(1.03); }
        .tournament-card .btn-join:active:not(:disabled) { transform: scale(0.99); }

        .my-matches-section, .games-section { margin-bottom: 25px; }
        .match-filters { display: flex; justify-content: space-between; gap: 10px; }
        .match-filter-btn { flex: 1; color: #fff; border: none; border-radius: 10px; padding: 12px 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform var(--transition-speed) ease; cursor: pointer; text-align: center; }
        .match-filter-btn:hover { transform: translateY(-3px); }
        .match-filter-btn:active { transform: translateY(0) scale(0.98); }
        .match-filter-btn i { font-size: 1.5rem; opacity: 0.9; } .match-filter-btn span { font-size: 0.8rem; }
        .game-type-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .game-type-tab { background-color: var(--secondary-bg); color: var(--text-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 25px; font-weight: 600; font-size: 0.9rem; transition: color var(--transition-speed) ease, background-color var(--transition-speed) ease, border-color var(--transition-speed) ease; }
        .game-type-tab.active { background-color: var(--info-color); color: #fff; border-color: var(--info-color); }
        
        .swiper-container#promotionSliderEl { width: 100%; height: auto; aspect-ratio: 16 / 9; border-radius: 10px; --swiper-pagination-color: var(--dynamic-accent); --swiper-pagination-bullet-inactive-color: var(--text-secondary); --swiper-pagination-bullet-size: 8px; position: relative; padding-bottom: 25px; }
        #promotionSliderEl .swiper-pagination { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: auto; }
        .swiper-slide { background-color: var(--secondary-bg); border-radius: 10px; position: relative; }
        .swiper-slide img, .swiper-slide iframe { display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 10px; border: none; }
        .youtube-thumbnail-container { position: relative; cursor: pointer; width: 100%; height: 100%; }
        .youtube-play-button { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 42px; background-color: rgba(0, 0, 0, 0.6); border-radius: 10px; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .youtube-play-button::after { content: ''; border-style: solid; border-width: 10px 0 10px 18px; border-color: transparent transparent transparent white; }
        .youtube-thumbnail-container img { pointer-events: none; }
        .close-video-btn { position: absolute; top: 10px; right: 10px; z-index: 10; background-color: rgba(0, 0, 0, 0.6); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 1.5rem; line-height: 30px; text-align: center; cursor: pointer; padding: 0; }

        #tournament-details-section .details-header { text-align: center; margin-bottom: 20px; }
        #tournament-details-section .details-header h4 { font-size: 1.2rem; margin: 0; color: var(--text-primary); }
        #tournament-details-section .details-header p { color: var(--text-secondary); font-size: 0.9rem; }
        .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .details-grid-item { background: var(--primary-bg); padding: 12px; border-radius: 8px; text-align: center; border: 1px solid var(--border-color); }
        .details-grid-item span { color: var(--text-secondary); font-size: 0.8rem; display: block; text-transform: uppercase; }
        .details-grid-item strong { color: var(--text-primary); font-size: 1rem; }
        .details-section-title { text-align: center; color: var(--text-secondary); margin-top: 25px; margin-bottom: 15px; font-weight: 600; font-size: 1rem; text-transform: uppercase; letter-spacing: 1px;}
        .rules-container .rule-item { background: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px 15px; margin-bottom: 10px; color: var(--text-primary); font-size: 0.9rem;}
        .rules-container .rule-item strong { color: var(--dynamic-accent); margin-right: 8px; }

        .details-footer-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px; padding-bottom: 15px;}
        .details-footer-actions .btn { padding: 12px; font-weight: 600; font-size: 1rem; border-radius: 8px; border: none; cursor: pointer; transition: filter var(--transition-speed) ease-in-out; }
        .details-footer-actions .btn:disabled { background-color: var(--secondary-bg); color: var(--text-secondary); cursor: not-allowed; border: 1px solid var(--border-color); }
        .details-footer-actions .btn-join-details { background-color: var(--info-color); color: #fff; }
        .details-footer-actions .btn-join-details:hover:not(:disabled) { filter: brightness(1.2); }
        .details-footer-actions .btn-view-joinings { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); }

        .room-details-container { background: var(--primary-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 15px; margin-bottom: 25px; }
        .room-detail-item { background: var(--secondary-bg); border-radius: 8px; padding: 10px 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 1rem; }
        .room-detail-item span { color: var(--text-secondary); font-weight: 500; }
        .room-detail-item strong { color: var(--text-primary); font-weight: 600; flex-grow: 1; text-align: center; letter-spacing: 1.5px; }
        .btn-copy-icon { background: none; border: none; color: var(--text-secondary); font-size: 1.2rem; padding: 5px; } .btn-copy-icon:hover { color: var(--text-primary); }
        
        .custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(16, 1, 26, 0.7); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index: 1060; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity var(--transition-speed) ease; }
        body.light-theme .custom-modal-overlay { background: rgba(255, 255, 255, 0.7); }
        .custom-modal-overlay.visible { display: flex; opacity: 1; }
        .custom-modal-content { background: var(--secondary-bg); padding: 1.5rem 2rem; border-radius: 15px; border: 1px solid var(--border-color); width: 90%; max-width: 320px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform: translateY(20px) scale(0.95); opacity: 0; transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .custom-modal-overlay.visible .custom-modal-content { transform: translateY(0) scale(1); opacity: 1; }
        .custom-modal-content h4 { color: var(--text-primary); font-weight: 600; margin-bottom: 0.8rem; }
        .custom-modal-content p { color: var(--text-secondary); font-size: 0.95rem; margin-bottom: 1.5rem; line-height: 1.5; }
        .custom-modal-actions { display: flex; gap: 10px; justify-content: center; margin-top: 1rem; }
        .custom-modal-actions .btn { flex: 1; padding: 10px; font-weight: 600; border-radius: 8px; border: none; cursor: pointer; transition: background-color var(--transition-speed) ease; }
        
        /* --- START FIX: Logout Confirmation Cancel Button --- */
        #customConfirmModalEl .btn.btn-custom-secondary {
            background: #F40076;
            color: white;
            border: none;
        }
        #customConfirmModalEl .btn.btn-custom-secondary:hover {
            filter: brightness(1.2);
        }
        /* --- END FIX --- */

        #selectPositionModalEl .modal-content { background-color: var(--secondary-bg); }
        #selectPositionModalEl .modal-header { border-bottom-color: var(--border-color); padding-bottom: 0; }
        #selectPositionModalEl .modal-title { color: var(--text-primary); font-weight: 600; }
        #selectPositionModalEl .modal-header p { color: var(--text-secondary); }
        .slot-legend { display: flex; justify-content: space-around; align-items: center; padding: 10px; background-color: var(--primary-bg); border-radius: 8px; margin-bottom: 20px; font-size: 0.8rem; }
        .legend-item { display: flex; align-items: center; gap: 8px; } .legend-color-box { width: 15px; height: 15px; border-radius: 4px; }
        
        #slotSelectionGridContainerEl { display: grid; grid-template-columns: 1fr 2.5fr; gap: 10px; }
        .team-labels-col, .slots-data-col { display: flex; flex-direction: column; gap: 15px; }
        .grid-header { color: var(--text-secondary); font-weight: 500; height: 30px; display: flex; align-items: flex-end; justify-content: center; font-size: 0.9rem; }
        .player-labels-header { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; height: 30px; }
        .player-labels-header > div { color: var(--text-secondary); text-align: center; font-weight: 500; font-size: 0.9rem; display: flex; align-items: flex-end; justify-content: center; }
        .team-label { color: var(--text-secondary); font-weight: 500; font-size: 0.9rem; height: 40px; display: flex; align-items: center; justify-content: center; }
        .slot-buttons-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .slot-btn { border: none; border-radius: 8px; height: 40px; font-weight: 600; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease, transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; }
        .slot-btn.available { background-color: var(--info-color); color: #fff; } .slot-btn.available:hover { filter: brightness(1.2); }
        .slot-btn.selected { background-color: var(--success-color); color: #fff; transform: scale(1.05); box-shadow: 0 0 15px rgba(16, 185, 129, 0.6); font-size: 1.2rem; font-weight: 700; }
        .slot-btn.booked { background-color: #3a2a57; color: #a797c2; cursor: not-allowed; }
        body.light-theme .slot-btn.booked { background-color: #f6f8fa; color: #6e7781; }

        .slot-modal-footer-custom { display: flex; gap: 15px; padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); background-color: var(--secondary-bg); }
        .slot-modal-footer-custom .btn { flex: 1; padding: 12px; font-weight: 600; font-size: 1rem; border-radius: 10px; border: none; color: #fff; transition: background-color var(--transition-speed) ease; }
        .slot-modal-footer-custom .btn-cancel { background-color: #F40076; }
        .slot-modal-footer-custom .btn-join { background-color: #ff8c00; }
        .slot-modal-footer-custom .btn-join:disabled { background-color: #6c757d; color: var(--text-primary); cursor: not-allowed; opacity: 0.6; }
        
        #addInfoModalEl .custom-modal-content { background: #201033; border: 1px solid #4a3a67; max-width: 360px; padding: 1.5rem; }
        #addInfoModalEl .info-summary { background-color: #1a0c2e; border: none; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; }
        #addInfoModalEl .info-summary strong { color: var(--text-primary); font-weight: 600; }
        #addInfoModalEl #infoModalTotalAmount { color: #ff8c00; }
        #addInfoModalEl #infoModalSlotsList .d-flex { justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .btn-add-info { transition: background-color var(--transition-speed) ease; }
        #addInfoModalEl .btn-add-info { background-color: var(--primary-button-bg); color: white; border: none; width: 110px; padding: 6px; border-radius: 6px; font-weight: 500; font-size: 0.85rem; }
        #addInfoModalEl .btn-add-info.info-added { background-color: var(--success-color); }
        #addInfoModalEl .custom-modal-actions .btn.btn-custom-secondary { background: #F40076; color: white; border: none; }
        #addInfoModalEl .custom-modal-actions .btn.btn-custom { background: #ff8c00; border: none; }

        #playerDetailsOverlayEl { z-index: 1070; }
        #playerDetailsContentEl { background: #201033; border: 1px solid #4a3a67; max-width: 360px; }
        #playerDetailsContentEl .form-control { background-color: #1a0c2e; color: var(--text-primary); border-color: var(--border-color); }
        .auth-modal-content .form-control::placeholder, .modal-body .form-control::placeholder, #playerDetailsContentEl .form-control::placeholder { color: var(--text-primary); opacity: 0.7; }
        #playerDetailsContentEl .btn.btn-custom-secondary { background: #F40076; color: white; border: none; }
        #playerDetailsContentEl .btn.btn-custom { background: var(--success-color); border: none; }
        
        .joinings-list-header { display: grid; grid-template-columns: 1fr 1fr 2.5fr 2fr; gap: 10px; padding: 10px 15px; border-bottom: 2px solid var(--border-color); color: var(--text-secondary); font-weight: 600; font-size: 0.9rem; text-align: center; }
        .joining-item { display: grid; grid-template-columns: 1fr 1fr 2.5fr 2fr; gap: 10px; padding: 12px 15px; background-color: var(--secondary-bg); border-radius: 8px; margin-bottom: 8px; align-items: center; text-align: center; font-size: 0.9rem; transition: background-color var(--transition-speed) ease-in-out; }
        .joining-item:hover { background-color: #2a1a4a; }
        .joining-item div { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }

        .notification-panel { position: fixed; top: 60px; right: -100%; width: 100%; max-width: 350px; height: calc(100vh - 60px); background-color: rgba(16, 1, 26, 0.7); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); border-left: 1px solid var(--border-color); z-index: 1040; display: flex; flex-direction: column; box-shadow: -5px 0 15px rgba(0,0,0,0.3); transition: right 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); }
        body.light-theme .notification-panel { background-color: rgba(246, 248, 250, 0.7); }
        .notification-panel.open { right: 0; }
        .notification-panel-header { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
        .notification-panel-header h5 { margin: 0; font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .notification-panel-close-btn { background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; }
        .notification-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .notification-item { display: flex; gap: 12px; padding: 12px; border-bottom: 1px solid var(--border-color); position: relative; }
        .notification-item:last-child { border-bottom: none; }
        .notification-item-icon { font-size: 1.5rem; color: #ff8c00; flex-shrink: 0; margin-top: 3px; }
        .notification-item-content { flex-grow: 1; }
        .notification-item-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 3px; color: var(--text-primary); }
        .notification-item-message { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4; }
        .notification-item-time { font-size: 0.75rem; color: #8272a3; margin-top: 5px; }
        .notification-item.unread::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 4px; height: 4px; border-radius: 50%; background-color: var(--info-color); }
        .notification-item-dismiss-btn { position: absolute; top: 5px; right: 5px; background: none; border: none; color: var(--text-secondary); font-size: 1.4rem; cursor: pointer; padding: 2px 8px; line-height: 1; transition: color var(--transition-speed) ease; }
        .notification-item-dismiss-btn:hover { color: var(--text-primary); }
        
        #wallet-section .section-title, #earnings-section .section-title { text-align: center; font-size: 1.6rem; margin-bottom: 25px; }
        .wallet-card-new { background: var(--secondary-bg); border-radius: 15px; padding: 20px; border: 1px solid var(--border-color); box-shadow: 0 8px 20px rgba(0,0,0,0.3); margin-bottom: 30px; }
        .wallet-total-balance { text-align: center; margin-bottom: 25px; }
        .wallet-total-balance span { font-size: 0.9rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; }
        .wallet-total-balance h3 { font-size: 2.8rem; font-weight: 700; color: var(--text-primary); margin: 5px 0; line-height: 1.2; }
        .wallet-total-balance a { font-size: 0.9rem; color: var(--dynamic-accent); font-weight: 500; }
        .wallet-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .wallet-actions .btn { padding: 12px; font-size: 1rem; font-weight: 600; border-radius: 10px; border: none; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform var(--transition-speed) ease; }
        .wallet-actions .btn:active { transform: scale(0.98); }
        .wallet-actions .btn-add-money { background-color: #ff8c00; color: #fff; }
        .wallet-actions .btn-withdraw-money { background-color: transparent; color: var(--text-primary); border: 2px solid var(--border-color); }
        .wallet-sub-balances { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .sub-balance-item { background-color: var(--primary-bg); padding: 15px; border-radius: 10px; border: 1px solid var(--border-color); }
        .sub-balance-item span { font-size: 0.85rem; color: var(--text-secondary); display: block; margin-bottom: 5px; }
        .sub-balance-item strong { font-size: 1.2rem; font-weight: 600; color: var(--text-primary); }
        #recentTransactionsListEl .transaction-item { background-color: var(--secondary-bg); padding: 12px 15px; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-color); }
        .transaction-details .desc { font-weight: 500; color: var(--text-primary); font-size: 0.95rem; }
        .transaction-details .date { font-size: 0.75rem; color: var(--text-secondary); }
        .transaction-amount { font-weight: 700; font-size: 1rem; }
        .transaction-amount.credit { color: var(--success-color); }
        .transaction-amount.debit { color: var(--danger-color); }

        .modal-content { background-color: var(--secondary-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 15px; }
        .modal-header { border-bottom: 1px solid var(--border-color); }
        .modal-header .modal-title { font-weight: 600; color: var(--text-primary); }
        .btn-close-white { filter: invert(1) grayscale(100%) brightness(200%); } body.light-theme .btn-close-white { filter: none; }
        .modal-body .form-control { background-color: var(--primary-bg); border: 1px solid var(--border-color); color: var(--text-primary); border-radius: 8px; padding: 10px; }
        .modal-body .form-control:focus { background-color: var(--primary-bg); border-color: #ff8c00; color: var(--text-primary); box-shadow: 0 0 0 0.2rem rgba(255, 140, 0, 0.25); }
        .modal-footer { border-top: 1px solid var(--border-color); display: flex; gap: 10px; }
        .modal-footer .btn { flex: 1; padding: 10px; font-weight: 600; border-radius: 8px; border: none; }
        #addAmountModalEl .modal-footer .btn { background-color: #ff8c00; color: white; }
        #withdrawModalEl .modal-footer .btn-custom-primary { background-color: #ff8c00; color: white; }
        #withdrawModalEl .modal-footer .btn-custom-secondary { background-color: #F40076; color: white; }
        #addAmountModalEl .text-warning { color: #ff8c00 !important; }
        #addAmountModalEl .phonepe-number { font-size: 1.1rem; letter-spacing: 1px; }
        #addAmountModalEl .bi-exclamation-triangle-fill { color: #F59E0B !important; }
        
        #profile-section { padding-top: 10px; }
        .profile-header-card { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 20px 10px; margin-bottom: 25px; }
        .profile-avatar { width: 80px; height: 80px; border-radius: 18px; object-fit: cover; border: 2px solid var(--border-color); margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .profile-name { font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin: 0; }
        .profile-email { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 20px; }
        .profile-stats { display: flex; justify-content: space-around; width: 100%; background: var(--secondary-bg); padding: 15px 10px; border-radius: 12px; border: 1px solid var(--border-color); }
        .profile-stats .stat-item { text-align: center; flex: 1; }
        .profile-stats .stat-item strong { display: block; font-size: 1.2rem; font-weight: 600; color: var(--text-primary); }
        .profile-stats .stat-item span { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
        
        .profile-links { margin-top: 25px; }
        .profile-links .list-group { background-color: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 15px; padding: 10px; overflow: hidden; }
        .profile-links .list-group-item { background-color: transparent; border: none; border-bottom: 1px solid var(--border-color); color: var(--text-primary); padding: 15px 10px; font-size: 0.95rem; font-weight: 500; cursor: pointer; transition: background-color var(--transition-speed) ease; }
        .profile-links .list-group-item:hover { background-color: var(--primary-bg); }
        .profile-links .list-group-item:last-child { border-bottom: none; }
        .profile-links .list-group-item i { margin-right: 15px; font-size: 1.2rem; width: 20px; text-align: center; color: var(--text-secondary); }
        .profile-links .list-group-item .bi-chevron-right { margin-right: 0; color: var(--text-secondary); }
        #logoutProfileBtnEl, #logoutProfileBtnEl i { color: var(--danger-color); }
        .form-check-input:checked { background-color: #ff8c00; border-color: #ff8c00; }
        
        /* --- FINAL SETTINGS STYLES --- */
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; font-size: 1rem; color: var(--text-primary); }
        .setting-item-column { padding: 10px 5px; }
        .setting-item i, .setting-item-column .form-label { margin-right: 15px; color: var(--text-secondary); }
        
        .theme-selector-custom { display: flex; background-color: var(--primary-bg); border-radius: 10px; padding: 5px; margin-top: 10px; border: 1px solid var(--border-color); }
        .theme-option { flex: 1; text-align: center; padding: 8px 10px; border-radius: 8px; cursor: pointer; font-weight: 500; color: var(--text-secondary); transition: color var(--transition-speed) ease, background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; display: flex; align-items: center; justify-content: center; gap: 8px; position: relative; }
        .theme-option .indicator { width: 10px; height: 10px; border-radius: 50%; background-color: transparent; border: 2px solid var(--text-secondary); transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease; }
        .theme-option.active { color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.3); background-color: var(--primary-button-bg); }
        .theme-option.active .indicator { background-color: #fff; border-color: #fff; }
        
        body.light-theme .theme-option { color: var(--text-secondary); }
        body.light-theme .theme-option.active { color: var(--text-primary); background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        body.light-theme .theme-option.active .indicator { background-color: var(--primary-button-bg); border-color: var(--primary-button-bg); }

        .earnings-card { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; }
        .earnings-box { background: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 15px; }
        .earnings-box.total-winnings { border-left: 4px solid; border-image-slice: 1; border-image-source: var(--dynamic-gradient); }
        .earnings-box.referral-earnings { border-left: 4px solid var(--info-color); }
        .earnings-icon { font-size: 2.5rem; }
        .earnings-box.total-winnings .earnings-icon { background: var(--dynamic-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .earnings-box.referral-earnings .earnings-icon { color: var(--info-color); }
        .earnings-details span { font-size: 0.9rem; color: var(--text-secondary); display: block; }
        .earnings-details strong { font-size: 1.8rem; font-weight: 600; color: var(--text-primary); display: block; line-height: 1.2; }
        .earnings-footer { text-align: center; }
        .earnings-footer .btn { width: 100%; max-width: 250px; padding: 12px; }
        
        #securityWarning { background-color: var(--warning-color); color: #111; padding: 10px 15px; text-align: center; font-size: 0.85rem; display: none; position: fixed; top: 60px; left: 0; width: 100%; z-index: 2000; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #securityWarning a, #securityWarning button { color: #000; font-weight: 600; text-decoration: underline; }
        #securityWarning button { background: none; border: none; font-size: 1.2rem; float: right; line-height: 1; padding: 0 5px; }
    </style>
</head>

<body>
     <div id="securityWarning">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <strong>Security Alert:</strong> Your database rules might be insecure.
        <a href="https://firebase.google.com/docs/database/security" target="_blank" rel="noopener noreferrer">Learn how to fix this.</a>
        <button onclick="this.parentElement.style.display='none'">&times;</button>
    </div>

    <header class="app-header"> 
        <div class="header-left"> 
            <button class="header-back-button" id="headerBackBtnEl"><i class="bi bi-arrow-left"></i></button>
            <a href="https://youtube.com/@killzasf?si=4dekhC_cEnc7DKVa" target="_blank" rel="noopener noreferrer">
                <img src="https://i.ibb.co/HDs94wDP/AI-Generated-Image-2025-06-25.jpg" alt="Killza Tournament Logo" class="header-logo" id="appLogoEl">
            </a>
            <div class="header-title" id="headerTitleContainerEl">
                <span class="header-brand-name">Killza</span>
                <span id="headerUserGreetingEl">Guest</span>
            </div> 
            <div class="header-game-title" id="headerGameTitleEl">Game Title</div> 
        </div> 
        <div class="header-right"> 
            <button class="notification-icon" id="notificationBtnEl"> <i class="bi bi-bell-fill"></i> <span class="notification-badge" style="display: none;"></span> </button> 
            <button class="wallet-chip" id="headerWalletChipEl" style="display: none;"> <i class="bi bi-wallet-fill"></i> ₹<span id="headerChipBalanceEl">0</span> </button> 
        </div> 
    </header> 
    
    <div class="notification-panel" id="notificationPanelEl">
        <div class="notification-panel-header">
            <h5>Notifications</h5>
            <button class="notification-panel-close-btn" id="notificationPanelCloseBtnEl">&times;</button>
        </div>
        <div class="notification-list" id="notificationListEl">
            <p id="noNotificationsMessageEl" class="text-secondary text-center mt-4 p-3">No notifications yet.</p>
        </div>
    </div>
    
    <div class="auth-modal-overlay" id="authModalOverlayEl"> <div class="auth-modal-content"> <button class="auth-modal-close" id="authModalCloseBtnEl">&times;</button> <form id="emailLoginForm" style="display: none;"> <h2 class="auth-modal-title">Login</h2> <div class="mb-3"> <label for="loginEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="loginEmailInputEl" placeholder="you@killza.gg" required> </div> <div class="mb-3"> <label for="loginPasswordInputEl" class="form-label">Password</label> <input type="password" class="form-control" id="loginPasswordInputEl" placeholder="••••••••" required> </div> <div id="loginStatusMessageEl" class="alert mt-3" style="display: none;"></div> <div class="d-grid gap-2 mb-3"> <button type="button" class="btn btn-custom" id="loginEmailBtnEl">Login</button> <a href="#" id="forgotPasswordLinkEl" class="text-center small mt-2 d-block" style="color: var(--text-secondary);">Forgot Password?</a> </div> <div class="text-center"> <button type="button" class="btn-custom-link btn-sm p-0" id="showSignupToggleBtnEl">Need an account? Sign Up</button> </div> </form> <form id="emailSignupForm" style="display: none;"> <h2 class="auth-modal-title">Create Account</h2> <div class="mb-3"> <label for="signupEmailInputEl" class="form-label">Email</label> <input type="email" class="form-control" id="signupEmailInputEl" placeholder="you@killza.gg" required> </div> <div class="mb-3"> <label for="signupPasswordInputEl" class="form-label">Password (min 6 chars)</label> <input type="password" class="form-control" id="signupPasswordInputEl" placeholder="••••••••" required minlength="6"> </div> <div class="mb-3"> <label for="signupConfirmPasswordInputEl" class="form-label">Confirm Password</label> <input type="password" class="form-control" id="signupConfirmPasswordInputEl" placeholder="••••••••" required> </div> <div class="mb-3"> <label for="signupReferralCodeInputEl" class="form-label">Referral Code (Optional)</label> <input type="text" class="form-control" id="signupReferralCodeInputEl" placeholder="Enter referral code"> </div> <div id="signupStatusMessageEl" class="alert mt-3" style="display: none;"></div> <div class="d-grid gap-2 mb-3"> <button type="button" class="btn btn-custom" id="signupEmailBtnEl">Sign Up</button> </div> <div class="text-center"> <button type="button" class="btn-custom-link btn-sm p-0" id="showLoginToggleBtnEl">Already have account? Login</button> </div> </form> </div> </div> <main class="main-content"> <div id="globalLoaderEl"> <div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div> </div> <section id="login-section" class="section"> <div class="welcome-container">
        <!-- START: WELCOME TITLE MODIFICATION -->
        <h1 class="welcome-title">Welcome to<br><span>Killza Army</span></h1>
        <!-- END: WELCOME TITLE MODIFICATION -->
        <p class="welcome-subtitle">Your one-stop place for gaming tournaments.</p> 
        <div class="welcome-actions"> <button class="btn btn-login-main" id="welcomeLoginBtn">Login</button> <button class="btn btn-create-main" id="welcomeCreateBtn">Create Account</button> </div> <div class="welcome-footer"> &copy; Killza. All rights reserved. <div> <a href="#" data-policy="terms" class="policy-link-footer">Terms</a> <a href="#" data-policy="privacy" class="policy-link-footer">Privacy</a> </div> </div> </div> </section> <section id="home-section" class="section"> 
            <h2 class="section-title">Promotions</h2>
            <div class="swiper-container" id="promotionSliderEl" style="margin-bottom: 25px;"> 
                <div class="swiper-wrapper placeholder-glow"> 
                    <div class="swiper-slide"><span class="placeholder" style="display: block; width: 100%; height: 100%; border-radius: 10px;"></span></div> 
                </div> 
                <div class="swiper-pagination"></div> 
            </div> 
            
            <div class="my-matches-section">
                <h2 class="section-title">My Matches</h2>
                <div class="match-filters">
                    <button class="match-filter-btn" data-status="upcoming" style="background-color: #3B82F6;">
                        <i class="bi bi-calendar-check"></i>
                        <span>Upcoming</span>
                    </button>
                    <button class="match-filter-btn" data-status="ongoing" style="background-color: #EF4444;">
                        <i class="bi bi-arrow-repeat"></i>
                        <span>Ongoing</span>
                    </button>
                    <button class="match-filter-btn" data-status="completed" style="background-color: #6C757D;">
                        <i class="bi bi-check-circle-fill"></i>
                        <span>Completed</span>
                    </button>
                </div>
            </div>

            <div class="games-section">
                <h2 class="section-title">Games</h2>
                <div class="game-type-tabs">
                    <button class="game-type-tab active" data-type="contests">Contests</button>
                    <button class="game-type-tab" data-type="challenges">Challenges</button>
                </div>
                <div id="gamesContent">
                    <div class="row g-3 mb-4 placeholder-glow" id="gamesListEl">
                        <div class="col-6">
                            <div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div>
                        </div>
                        <div class="col-6">
                            <div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px; border-top-left-radius: 8px; border-top-right-radius: 8px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div>
                        </div>
                    </div>
                </div>
                <div id="challengesContent" style="display: none;">
                    <div class="row g-3 mb-4" id="challengesGameListEl"></div>
                </div>
            </div>
        </section> <section id="tournaments-section" class="section"> 
            
            <div class="tournament-tabs">
                <button class="tab-item active" data-status="upcoming"><i class="bi bi-calendar-check"></i> Upcoming</button>
                <button class="tab-item" data-status="ongoing"><i class="bi bi-arrow-repeat"></i> Ongoing</button>
                <button class="tab-item" data-status="completed"><i class="bi bi-check-circle-fill"></i> Completed</button>
            </div>

            <div id="tournamentsListContainerEl" class="mt-3"></div> <p id="noTournamentsMessageEl" class="text-secondary text-center mt-4" style="display: none;">No tournaments found.</p> </section> <section id="tournament-details-section" class="section"></section> 
    
    <section id="all-joinings-section" class="section">
    </section>

    <section id="wallet-section" class="section">
        <h2 class="section-title">My Wallet</h2>

        <div class="wallet-card-new">
            <div class="wallet-total-balance placeholder-glow">
                <span>Total Balance</span>
                <h3 id="walletTotalBalanceEl"><span class="placeholder col-4"></span></h3>
                <a href="#" id="allTransactionsBtnEl">View Transaction History <i class="bi bi-chevron-right"></i></a>
            </div>

            <div class="wallet-actions">
                <button class="btn btn-add-money" id="addAmountWalletBtnEl">
                    <i class="bi bi-plus-circle-fill"></i> Add Amount
                </button>
                <button class="btn btn-withdraw-money" id="withdrawBtnEl">
                    <i class="bi bi-arrow-down-up"></i> Withdraw
                </button>
            </div>

            <div class="wallet-sub-balances">
                <div class="sub-balance-item placeholder-glow">
                    <span>Winning Cash</span>
                    <strong id="walletWinningCashEl"><span class="placeholder col-6"></span></strong>
                </div>
                <div class="sub-balance-item placeholder-glow">
                    <span>Bonus Cash</span>
                    <strong id="walletBonusCashEl"><span class="placeholder col-6"></span></strong>
                </div>
            </div>
        </div>

        <h3 class="section-title" style="font-size: 1.3rem; text-align: left;">Recent Transactions</h3>
        <div id="recentTransactionsListEl" class="placeholder-glow">
            <div class="transaction-item placeholder-glow">
                <div class="transaction-details">
                    <div class="desc"><span class="placeholder col-7"></span></div>
                    <div class="date"><span class="placeholder col-9"></span></div>
                </div>
                <div class="transaction-amount"><span class="placeholder col-3"></span></div>
            </div>
             <div class="transaction-item placeholder-glow">
                <div class="transaction-details">
                    <div class="desc"><span class="placeholder col-6"></span></div>
                    <div class="date"><span class="placeholder col-8"></span></div>
                </div>
                <div class="transaction-amount"><span class="placeholder col-4"></span></div>
            </div>
            <p class="text-secondary text-center mt-3" id="noTransactionsMessageEl" style="display: none;">Loading transactions...</p>
        </div>
    </section>
    
    <section id="earnings-section" class="section">
        <h2 class="section-title">My Earnings</h2>

        <div class="earnings-card">
            <div class="earnings-box total-winnings placeholder-glow">
                <div class="earnings-icon"><i class="bi bi-trophy-fill"></i></div>
                <div class="earnings-details">
                    <span>Total Winnings</span>
                    <strong id="earningsTotalEl"><span class="placeholder col-5"></span></strong>
                </div>
            </div>
            <div class="earnings-box referral-earnings placeholder-glow">
                <div class="earnings-icon"><i class="bi bi-people-fill"></i></div>
                <div class="earnings-details">
                    <span>From Referrals</span>
                    <strong id="earningsReferralEl"><span class="placeholder col-5"></span></strong>
                </div>
            </div>
        </div>
        
        <div class="earnings-footer">
             <p class="text-secondary small mb-3">Track your earnings from tournaments and referrals here.</p>
            <button class="btn btn-custom" id="viewEarningsHistoryBtn">View History</button>
        </div>
    </section>

    <section id="earnings-history-section" class="section">
    </section>
    
    <section id="profile-section" class="section">
        <div class="profile-header-card placeholder-glow">
            <img src="https://via.placeholder.com/80" alt="User Profile Avatar" class="profile-avatar" id="profileAvatarEl">
            <h3 class="profile-name" id="profileNameEl"><span class="placeholder col-6"></span></h3>
            <p class="profile-email" id="profileEmailEl"><span class="placeholder col-8"></span></p>
            
            <div class="profile-stats">
                <div class="stat-item"><strong id="profileTotalMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Played</span></div>
                <div class="stat-item"><strong id="profileWonMatchesEl"><span class="placeholder col-4"></span></strong><span>Matches Won</span></div>
                <div class="stat-item"><strong id="profileTotalEarningsEl"><span class="placeholder col-4"></span></strong><span>Total Winnings</span></div>
            </div>
        </div>
        
        <div class="profile-links">
            <div class="list-group">
                <div class="list-group-item">
                    <div class="setting-item">
                        <span><i class="bi bi-bell-fill"></i> Notifications</span>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="notificationSwitchEl" checked>
                        </div>
                    </div>
                </div>
                <div class="list-group-item">
                    <div class="setting-item-column">
                        <label class="form-label mb-2"><i class="bi bi-palette-fill"></i> App Theme</label>
                         <div class="theme-selector-custom" id="themeSelectorEl">
                            <div class="theme-option" data-theme="killza"><span class="indicator"></span> Killza</div>
                            <div class="theme-option" data-theme="dark"><span class="indicator"></span> Dark</div>
                            <div class="theme-option" data-theme="light"><span class="indicator"></span> Light</div>
                        </div>
                    </div>
                </div>
                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-policy="refer">
                    <span><i class="bi bi-person-plus-fill"></i> Refer & Earn</span>
                    <i class="bi bi-chevron-right"></i>
                </a>
                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-policy="privacy">
                    <span><i class="bi bi-shield-lock-fill"></i> Privacy Policy</span><i class="bi bi-chevron-right"></i>
                </a>
                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-policy="terms">
                    <span><i class="bi bi-file-text-fill"></i> Terms and Conditions</span><i class="bi bi-chevron-right"></i>
                </a>
                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-policy="refund">
                    <span><i class="bi bi-arrow-repeat"></i> Refund and Cancellation</span><i class="bi bi-chevron-right"></i>
                </a>
                <a href="#" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-policy="fairPlay">
                    <span><i class="bi bi-patch-check-fill"></i> Fair Play Policy</span><i class="bi bi-chevron-right"></i>
                </a>
                <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" id="logoutProfileBtnEl">
                    <span><i class="bi bi-box-arrow-right"></i> Logout</span><span></span>
                </button>
            </div>
        </div>
    </section>
    </main> 
    
    <div class="modal fade" id="policyModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-scrollable modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="policyModalTitleEl">Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="policyModalBodyEl" style="min-height: 300px;"></div></div></div></div> <div class="modal fade" id="addAmountModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-wallet-fill me-2"></i> How to Add Amount?</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p>To add amount, pay via UPI/PhonePe to:</p><p class="text-center text-warning"><strong>UPI ID/Number:</strong> <span class="phonepe-number">[!!! YOUR UPI ID/NUMBER HERE !!!]</span></p><p class="mt-3 small"><strong><i class="bi bi-exclamation-triangle-fill text-warning"></i> IMPORTANT:</strong> After payment, contact admin via [!!! ADMIN CONTACT INFO HERE !!!] with registered Email (<strong id="modalUserEmailEl">...</strong>) & payment screenshot. Amount added manually after verification.</p></div><div class="modal-footer"><button type="button" class="btn btn-custom" data-bs-dismiss="modal">Got it</button></div></div></div></div> <div class="modal fade" id="withdrawModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title"><i class="bi bi-cash-coin me-2"></i> Withdraw Funds</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><p class="small text-secondary">Withdrawable balance: <strong id="withdrawModalBalanceEl">₹0.00</strong></p><div class="mb-3"><label for="withdrawAmountInputEl" class="form-label">Amount (Min ₹<span id="minWithdrawAmountEl">50</span>)</label><input type="number" class="form-control" id="withdrawAmountInputEl" placeholder="Enter amount"></div><div class="mb-3"><label for="withdrawMethodInputEl" class="form-label">Withdrawal Method (UPI/Bank)</label><input type="text" class="form-control" id="withdrawMethodInputEl" placeholder="Enter UPI ID / Bank Details"></div><div id="withdrawStatusMessageEl" class="alert mt-3" style="display: none;"></div></div><div class="modal-footer"><button type="button" class="btn btn-custom-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-custom-primary" id="submitWithdrawRequestBtnEl">Submit Request</button></div></div></div></div> <div class="modal fade" id="matchDetailsModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="matchDetailsModalTitleEl">Match Details</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body" id="matchDetailsModalBodyEl"></div></div></div></div> <div class="modal fade" id="idPasswordModalEl" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Room ID & Password</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body text-center"><p class="small text-secondary">ID/Pass shown shortly before match start.</p><div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="mb-1">Room ID:</p><h4 id="roomIdDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span class="placeholder col-6"></span></h4><button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomIdDisplayEl" title="Copy Room ID"><i class="bi bi-clipboard"></i></button></div><div class="my-3 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="mb-1">Password:</p><h4 id="roomPasswordDisplayEl" class="text-accent referral-code placeholder-glow d-inline-block"><span class="placeholder col-6"></span></h4><button class="btn btn-sm btn-outline-warning ms-2 copy-btn" data-target="#roomPasswordDisplayEl" title="Copy Password"><i class="bi bi-clipboard"></i></button></div><p class="small text-warning"><i class="bi bi-exclamation-triangle"></i> Don't share ID/Password.</p></div></div></div></div>
    
    <div class="modal fade" id="selectPositionModalEl" tabindex="-1" aria-labelledby="selectPositionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title" id="selectPositionModalLabel">Joining Match</h5>
                        <p class="text-secondary small mb-0">Choose your preferred position in the match</p>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="slot-legend">
                        <div class="legend-item"><div class="legend-color-box" style="background-color: var(--info-color);"></div> Available</div>
                        <div class="legend-item"><div class="legend-color-box" style="background-color: var(--success-color);"></div> Selected</div>
                        <div class="legend-item"><div class="legend-color-box" style="background-color: #3a2a57;"></div> Booked</div>
                    </div>
                    <div id="slotSelectionGridContainerEl">
                         <div class="text-center p-4">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading Slots...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="slot-modal-footer-custom">
                    <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-join" id="confirmJoinSlotBtnEl" disabled>Next</button>
                </div>
            </div>
        </div>
    </div>

    <div class="custom-modal-overlay" id="customAlertModalEl">
        <div class="custom-modal-content">
            <h4 id="customAlertTitleEl">Notification</h4>
            <p id="customAlertMessageEl">This is a custom message.</p>
            <div class="custom-modal-actions">
                 <button class="btn btn-custom" id="customAlertOkBtnEl">OK</button>
            </div>
        </div>
    </div>

    <div class="custom-modal-overlay" id="customConfirmModalEl">
        <div class="custom-modal-content">
            <h4 id="customConfirmTitleEl">Confirm</h4>
            <p id="customConfirmMessageEl">Are you sure?</p>
            <div class="custom-modal-actions">
                <button class="btn btn-custom-secondary" id="customConfirmCancelBtnEl">Cancel</button>
                <button class="btn btn-custom" id="customConfirmOkBtnEl">OK</button>
            </div>
        </div>
    </div>

    <div class="custom-modal-overlay" id="addInfoModalEl">
        <div class="custom-modal-content">
            <h4 id="addInfoTitleEl" class="text-center">Confirm Your Team</h4>
            
            <div class="info-summary">
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-secondary">Your Balance:</span>
                    <strong id="infoModalWalletBalance">₹0.00</strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-secondary">Entry Fee / Person:</span>
                    <strong id="infoModalEntryFee">₹0.00</strong>
                </div>
                <hr style="border-color: var(--border-color);">
                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-secondary">Total Payable:</span>
                    <strong id="infoModalTotalAmount" style="font-size: 1.1rem;">₹0.00</strong>
                </div>
            </div>

            <p class="text-secondary small mb-2 text-start">Enter In-Game Name & ID for each position:</p>
            <div id="infoModalSlotsList" class="mb-3" style="max-height: 200px; overflow-y: auto; padding-right: 5px;">
            </div>
            <p class="text-warning small"><i class="bi bi-exclamation-triangle-fill"></i> Please enter correct In-Game details. They cannot be changed later.</p>
            
            <div id="infoModalStatusMessageEl" class="alert mt-3" style="display: none;"></div>

            <div class="custom-modal-actions mt-4">
                <button class="btn btn-custom-secondary" id="infoModalCancelBtn">Cancel</button>
                <button class="btn btn-custom" id="infoModalConfirmJoinBtn" disabled>Confirm & Join</button>
            </div>
        </div>
    </div>

    <div class="custom-modal-overlay" id="playerDetailsOverlayEl">
        <div class="custom-modal-content" id="playerDetailsContentEl">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 id="playerDetailsModalLabel" class="m-0" style="font-size: 1.2rem;">Details for Team...</h4>
                <button id="playerDetailsCloseBtn" class="auth-modal-close" style="position: static; font-size: 1.5rem;">&times;</button>
            </div>
            <div id="playerDetailsStatusMessageEl" class="alert" style="display: none;"></div>
            <div class="mb-3 text-start">
                <label for="inGameNameInput" class="form-label">In-Game Name</label>
                <input type="text" class="form-control" id="inGameNameInput" placeholder="Enter player's name in the game">
            </div>
            <div class="mb-3 text-start">
                <label for="inGameIdInput" class="form-label">In-Game ID</label>
                <input type="text" class="form-control" id="inGameIdInput" placeholder="Enter player's character ID">
            </div>
            <div class="custom-modal-actions">
                <button class="btn btn-custom-secondary" id="playerDetailsCancelBtn">Cancel</button>
                <button class="btn btn-custom" id="savePlayerDetailsBtn">Save</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav"> <button class="nav-item active" data-section="home-section"><i class="bi bi-house-door-fill"></i><span>Home</span></button> <button class="nav-item" data-section="wallet-section"><i class="bi bi-wallet-fill"></i><span>Wallet</span></button> <button class="nav-item" data-section="earnings-section"><i class="bi bi-coin"></i><span>Earnings</span></button> <button class="nav-item" data-section="profile-section"><i class="bi bi-person-fill"></i><span>Profile</span></button> </nav>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, get, set, update, push, query, onValue, runTransaction, off, limitToLast, serverTimestamp, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBsxfCcg-GJnG03ycgeDN2ppwhWn1-FU5g",
            authDomain: "killza-tournament.firebaseapp.com",
            databaseURL: "https://killza-tournament-default-rtdb.firebaseio.com",
            projectId: "killza-tournament",
            storageBucket: "killza-tournament.firebasestorage.app",
            messagingSenderId: "792683907529",
            appId: "1:792683907529:web:e6ca176412eb09ce9c0018",
            measurementId: "G-T0HC44FK2S"
        };
        
        let app, db, auth;
        try { if (firebaseConfig.apiKey.includes("YOUR_API_KEY")) { console.warn("Firebase config using placeholder values."); } app = initializeApp(firebaseConfig); db = getDatabase(app); auth = getAuth(app); console.log("Firebase Initialized"); } catch (error) { console.error("Firebase initialization failed:", error); document.body.innerHTML = `<div class="alert alert-danger m-5 position-fixed top-0 start-0 end-0">Critical Error: Could not connect. Check Firebase config.</div>`; }
        
        const getElement = (id) => document.getElementById(id);
        const querySel = (selector) => document.querySelector(selector);
        const querySelAll = (selector) => document.querySelectorAll(selector);
        
        const elements = { 
            sections: querySelAll('.section'), bottomNavItems: querySelAll('.bottom-nav .nav-item'), globalLoader: getElement('globalLoaderEl'), headerBackBtn: getElement('headerBackBtnEl'), headerTitleContainer: getElement('headerTitleContainerEl'), headerGameTitle: getElement('headerGameTitleEl'), headerWalletChip: getElement('headerWalletChipEl'), headerChipBalance: getElement('headerChipBalanceEl'), headerUserGreeting: getElement('headerUserGreetingEl'), appLogo: getElement('appLogoEl'), notificationBtn: getElement('notificationBtnEl'), notificationBadge: querySel('.notification-badge'), loginSection: getElement('login-section'), authModalOverlay: getElement('authModalOverlayEl'), authModalCloseBtn: getElement('authModalCloseBtnEl'), welcomeLoginBtn: getElement('welcomeLoginBtn'), welcomeCreateBtn: getElement('welcomeCreateBtn'), emailLoginForm: getElement('emailLoginForm'), loginEmailInput: getElement('loginEmailInputEl'), loginPasswordInput: getElement('loginPasswordInputEl'), loginEmailBtn: getElement('loginEmailBtnEl'), showSignupToggleBtn: getElement('showSignupToggleBtnEl'), loginStatusMessage: getElement('loginStatusMessageEl'), forgotPasswordLink: getElement('forgotPasswordLinkEl'), emailSignupForm: getElement('emailSignupForm'), signupEmailInput: getElement('signupEmailInputEl'), signupPasswordInput: getElement('signupPasswordInputEl'), signupConfirmPasswordInput: getElement('signupConfirmPasswordInputEl'), signupReferralCodeInput: getElement('signupReferralCodeInputEl'), signupEmailBtn: getElement('signupEmailBtnEl'), showLoginToggleBtn: getElement('showLoginToggleBtnEl'), signupStatusMessage: getElement('signupStatusMessageEl'), homeSection: getElement('home-section'), promotionSlider: getElement('promotionSliderEl'), 
            gamesList: getElement('gamesListEl'), challengesGameList: getElement('challengesGameListEl'),
            tournamentsSection: getElement('tournaments-section'), tournamentsListContainer: getElement('tournamentsListContainerEl'), noTournamentsMessage: getElement('noTournamentsMessageEl'), tournamentTabs: querySelAll('.tournament-tabs .tab-item'), walletSection: getElement('wallet-section'), walletTotalBalance: getElement('walletTotalBalanceEl'), walletWinningCash: getElement('walletWinningCashEl'), walletBonusCash: getElement('walletBonusCashEl'), allTransactionsBtn: getElement('allTransactionsBtnEl'), withdrawBtn: getElement('withdrawBtnEl'), addAmountWalletBtn: getElement('addAmountWalletBtnEl'), recentTransactionsList: getElement('recentTransactionsListEl'), noTransactionsMessage: getElement('noTransactionsMessageEl'), earningsSection: getElement('earnings-section'), earningsTotal: getElement('earningsTotalEl'), earningsReferral: getElement('earningsReferralEl'), viewEarningsHistoryBtn: getElement('viewEarningsHistoryBtn'), earningsHistorySection: getElement('earnings-history-section'), profileSection: getElement('profile-section'), profileAvatar: getElement('profileAvatarEl'), profileName: getElement('profileNameEl'), profileEmail: getElement('profileEmailEl'), profileTotalMatches: getElement('profileTotalMatchesEl'), profileWonMatches: getElement('profileWonMatchesEl'), profileTotalEarnings: getElement('profileTotalEarningsEl'), logoutProfileBtn: getElement('logoutProfileBtnEl'), policyLinks: querySelAll('.profile-links a, .profile-links button'),
            notificationSwitch: getElement('notificationSwitchEl'),
            themeOptions: querySelAll('.theme-option'),
            policyLinksFooter: querySelAll('.policy-link-footer'), policyModalInstance: getElement('policyModalEl') ? new bootstrap.Modal(getElement('policyModalEl')) : null, policyModalTitle: getElement('policyModalTitleEl'), policyModalBody: getElement('policyModalBodyEl'), addAmountModalInstance: getElement('addAmountModalEl') ? new bootstrap.Modal(getElement('addAmountModalEl')) : null, modalUserEmail: getElement('modalUserEmailEl'), withdrawModalInstance: getElement('withdrawModalEl') ? new bootstrap.Modal(getElement('withdrawModalEl')) : null, withdrawModalBalance: getElement('withdrawModalBalanceEl'), withdrawAmountInput: getElement('withdrawAmountInputEl'), withdrawMethodInput: getElement('withdrawMethodInputEl'), minWithdrawAmount: getElement('minWithdrawAmountEl'), withdrawStatusMessage: getElement('withdrawStatusMessageEl'), submitWithdrawRequestBtn: getElement('submitWithdrawRequestBtnEl'), matchDetailsModalInstance: getElement('matchDetailsModalEl') ? new bootstrap.Modal(getElement('matchDetailsModalEl')) : null, matchDetailsModalTitle: getElement('matchDetailsModalTitleEl'), matchDetailsModalBody: getElement('matchDetailsModalBodyEl'), idPasswordModalInstance: getElement('idPasswordModalEl') ? new bootstrap.Modal(getElement('idPasswordModalEl')) : null, roomIdDisplay: getElement('roomIdDisplayEl'), roomPasswordDisplay: getElement('roomPasswordDisplayEl'), securityWarning: getElement('securityWarning'), customAlertModal: getElement('customAlertModalEl'), customAlertTitle: getElement('customAlertTitleEl'), customAlertMessage: getElement('customAlertMessageEl'), customAlertOkBtn: getElement('customAlertOkBtnEl'), customConfirmModal: getElement('customConfirmModalEl'), customConfirmTitle: getElement('customConfirmTitleEl'), customConfirmMessage: getElement('customConfirmMessageEl'), customConfirmOkBtn: getElement('customConfirmOkBtnEl'), customConfirmCancelBtn: getElement('customConfirmCancelBtnEl'),
            allJoiningsSection: getElement('all-joinings-section'),
            selectPositionModalInstance: getElement('selectPositionModalEl') ? new bootstrap.Modal(getElement('selectPositionModalEl')) : null, slotSelectionGridContainer: getElement('slotSelectionGridContainerEl'), confirmJoinSlotBtn: getElement('confirmJoinSlotBtnEl'),
            addInfoModalEl: getElement('addInfoModalEl'), addInfoTitleEl: getElement('addInfoTitleEl'), infoModalWalletBalance: getElement('infoModalWalletBalance'), infoModalEntryFee: getElement('infoModalEntryFee'), infoModalTotalAmount: getElement('infoModalTotalAmount'), infoModalSlotsList: getElement('infoModalSlotsList'), infoModalStatusMessageEl: getElement('infoModalStatusMessageEl'), infoModalCancelBtn: getElement('infoModalCancelBtn'), infoModalConfirmJoinBtn: getElement('infoModalConfirmJoinBtn'),
            playerDetailsOverlayEl: getElement('playerDetailsOverlayEl'), playerDetailsContentEl: getElement('playerDetailsContentEl'), playerDetailsModalLabel: getElement('playerDetailsModalLabel'), inGameNameInput: getElement('inGameNameInput'), inGameIdInput: getElement('inGameIdInput'), savePlayerDetailsBtn: getElement('savePlayerDetailsBtn'), playerDetailsStatusMessageEl: getElement('playerDetailsStatusMessageEl'), playerDetailsCloseBtn: getElement('playerDetailsCloseBtn'), playerDetailsCancelBtn: getElement('playerDetailsCancelBtn'),
            notificationPanel: getElement('notificationPanelEl'), notificationList: getElement('notificationListEl'), notificationPanelCloseBtn: getElement('notificationPanelCloseBtnEl'), noNotificationsMessage: getElement('noNotificationsMessageEl'),
        };
        let currentUser = null; let userProfile = {}; let currentSectionId = 'login-section'; let dbListeners = {};
        let swiperInstance; let currentTournamentGameId = null; let appSettings = {};
        let isShowingMyMatches = false; let validReferrerUid = null; let temporaryTeamInfo = {}; let lastTournamentDetailsId = null; 

        // --- THEME MANAGEMENT ---
        function setTheme(theme) {
            document.body.classList.remove('light-theme', 'dark-theme', 'killza-theme');
            
            switch(theme) {
                case 'light': document.body.classList.add('light-theme'); break;
                case 'killza': document.body.classList.add('killza-theme'); break;
                case 'dark': 
                default: document.body.classList.add('dark-theme'); break;
            }
            localStorage.setItem('theme', theme);

            elements.themeOptions.forEach(opt => {
                opt.classList.toggle('active', opt.dataset.theme === theme);
            });
        }
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'killza';
            setTheme(savedTheme);
        }

        // --- ANIMATION HELPER ---
        function animateSectionContent(sectionId) {
            const section = getElement(sectionId);
            if (!section) return;
            const itemsToAnimate = section.querySelectorAll('.game-card, .tournament-card, .transaction-item, .profile-links .list-group-item, .earnings-box, .match-filter-btn, .wallet-card-new, .profile-header-card, .profile-settings-action');
            itemsToAnimate.forEach((item, index) => {
                item.classList.remove('animated-item');
                setTimeout(() => {
                    item.style.animationDelay = `${index * 60}ms`;
                    item.classList.add('animated-item');
                }, 10);
            });
        }


        const showLoader = (show) => { if (elements.globalLoader) elements.globalLoader.style.display = show ? 'flex' : 'none'; };
        function showStatusMessage(element, message, type = 'danger', autohide = true) { if (!element) return; element.innerHTML = message; element.className = `alert alert-${type} mt-3`; element.style.display = 'block'; element.setAttribute('role', 'alert'); if (autohide) { setTimeout(() => { if (element.innerHTML === message) element.style.display = 'none'; }, 5000); } }
        function clearStatusMessage(element) { if (!element) return; element.style.display = 'none'; element.innerHTML = ''; element.removeAttribute('role'); }
        
        function showCustomAlert(title, message) { if (!elements.customAlertModal) return; elements.customAlertTitle.textContent = title; elements.customAlertMessage.textContent = message; elements.customAlertModal.classList.add('visible'); }
        function hideCustomAlert() { if (!elements.customAlertModal) return; elements.customAlertModal.classList.remove('visible'); }

        function showCustomConfirm(title, message) {
            return new Promise((resolve) => {
                if (!elements.customConfirmModal) { resolve(false); return; }
                elements.customConfirmTitle.textContent = title;
                elements.customConfirmMessage.textContent = message;
                elements.customConfirmModal.classList.add('visible');
                const cleanupAndResolve = (value) => { elements.customConfirmModal.classList.remove('visible'); elements.customConfirmOkBtn.onclick = null; elements.customConfirmCancelBtn.onclick = null; elements.customConfirmModal.onclick = null; resolve(value); };
                elements.customConfirmOkBtn.onclick = () => cleanupAndResolve(true);
                elements.customConfirmCancelBtn.onclick = () => cleanupAndResolve(false);
                elements.customConfirmModal.onclick = (e) => { if (e.target === elements.customConfirmModal) { cleanupAndResolve(false); } };
            });
        }
        
        function toggleNotificationsPanel(forceClose = false) { if (!elements.notificationPanel) return; const isOpen = elements.notificationPanel.classList.contains('open'); if (forceClose || isOpen) { elements.notificationPanel.classList.remove('open'); } else { elements.notificationPanel.classList.add('open'); markNotificationsAsRead(); } }
        
        async function markNotificationsAsRead() {
            if (elements.notificationList) { elements.notificationList.querySelectorAll('.notification-item.unread').forEach(item => item.classList.remove('unread')); }
            if (!currentUser) return;
            updateNotificationBadge(0);
            const userRef = ref(db, `users/${currentUser.uid}`);
            try { await update(userRef, { lastCheckedNotifications: serverTimestamp() }); console.log("User's notification timestamp updated."); } catch (error) { console.error("Failed to update last notification check time:", error); }
        }
        
        function updateNotificationBadge(count) { if (!elements.notificationBadge) return; if (count > 0) { elements.notificationBadge.textContent = count > 9 ? '9+' : count; elements.notificationBadge.style.display = 'flex'; } else { elements.notificationBadge.style.display = 'none'; } }
        
        function timeAgo(timestamp) { const now = Date.now(); const seconds = Math.floor((now - timestamp) / 1000); let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " years ago"; interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " months ago"; interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " days ago"; interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " hours ago"; interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " minutes ago"; return "Just now"; }

        function renderNotification(notification) {
            if (!elements.notificationList || !notification.timestamp || typeof notification.timestamp !== 'number' || !currentUser) return;

            // FIX: Automatically hide notifications older than 24 hours
            const twentyFourHoursInMs = 24 * 60 * 60 * 1000;
            if (Date.now() - notification.timestamp > twentyFourHoursInMs) {
                return; // Notification is too old, do not render.
            }

            // FIX: Check localStorage to prevent re-showing dismissed notifications
            const dismissedKey = `dismissedNotifications_${currentUser.uid}`;
            try {
                const dismissedNotifications = JSON.parse(localStorage.getItem(dismissedKey) || '[]');
                if (dismissedNotifications.includes(notification.timestamp)) {
                    return; // This notification was already dismissed by the user.
                }
            } catch (e) {
                console.error("Could not parse dismissed notifications:", e);
                localStorage.removeItem(dismissedKey); // Clear corrupted data
            }
            
            elements.noNotificationsMessage.style.display = 'none';
            const item = document.createElement('div');
            item.className = 'notification-item animated-item';
            const lastChecked = userProfile.lastCheckedNotifications || 0;
            if (notification.timestamp > lastChecked) { item.classList.add('unread'); }
            
            let iconClass = 'bi-bell-fill';
            if(notification.type === 'new_tournament') iconClass = 'bi-trophy-fill';
            if(notification.type === 'new_promotion') iconClass = 'bi-megaphone-fill';

            let messageHtml = notification.message || '';
            if (notification.gameName) { messageHtml += `<br><small style="color: var(--text-secondary);"><strong>Game:</strong> ${notification.gameName}</small>`; }
            if (notification.map) { messageHtml += `<small style="color: var(--text-secondary); margin-left: 8px;"><strong>Map:</strong> ${notification.map}</small>`; }
            if (notification.prizePool) { messageHtml += `<small style="color: var(--text-secondary); margin-left: 8px;"><strong>Prize:</strong> ₹${notification.prizePool}</small>`; }

            item.innerHTML = `<div class="notification-item-icon"><i class="bi ${iconClass}"></i></div> <div class="notification-item-content"> <div class="notification-item-title">${notification.title || 'Notification'}</div> <div class="notification-item-message">${messageHtml}</div> <div class="notification-item-time">${timeAgo(notification.timestamp)}</div> </div> <button class="notification-item-dismiss-btn" title="Dismiss">&times;</button>`;
            
            const dismissBtn = item.querySelector('.notification-item-dismiss-btn');
            dismissBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                // FIX: Save the dismissed notification timestamp to localStorage
                try {
                    let dismissed = JSON.parse(localStorage.getItem(dismissedKey) || '[]');
                    if (!dismissed.includes(notification.timestamp)) {
                        dismissed.push(notification.timestamp);
                    }
                    // Clean up old entries from localStorage to prevent it from getting too large
                    const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
                    const cleanedDismissed = dismissed.filter(ts => typeof ts === 'number' && ts > thirtyDaysAgo);
                    localStorage.setItem(dismissedKey, JSON.stringify(cleanedDismissed));
                } catch (err) {
                    console.error("Failed to save dismissed notification:", err);
                }

                // FIX: Add a slide-out animation before removing the element
                item.style.transition = 'transform 0.4s ease-in-out, opacity 0.4s ease-in-out';
                item.style.transform = 'translateX(100%)'; // Slide out to the right
                item.style.opacity = '0';
                
                setTimeout(() => {
                    item.remove();
                    if (elements.notificationList.querySelectorAll('.notification-item').length === 0) {
                        elements.noNotificationsMessage.style.display = 'block';
                    }
                }, 400); // This duration should match the CSS transition time
            });
            elements.notificationList.prepend(item);
        }

        function setupNotificationListener(uid) {
            const notificationsRef = query(ref(db, 'notifications/global'), limitToLast(20));
            dbListeners['notifications'] = {
                path: 'notifications/global',
                func: onValue(notificationsRef, (snapshot) => {
                    if (!snapshot.exists()) return;
                    elements.notificationList.innerHTML = '';
                    const allNotifications = [];
                    snapshot.forEach(childSnapshot => { allNotifications.push(childSnapshot.val()); });
                    allNotifications.reverse();
                    let unreadCount = 0;
                    const lastChecked = userProfile.lastCheckedNotifications || 0;
                    allNotifications.forEach(notification => { renderNotification(notification); if (notification.timestamp > lastChecked) { unreadCount++; } });
                    updateNotificationBadge(unreadCount);
                }, (error) => { console.error("Notification listener error:", error); })
            };
        }
        
        async function updateMyMatchesCounts() {
            const upcomingSpan = querySel('.match-filter-btn[data-status="upcoming"] span');
            const ongoingSpan = querySel('.match-filter-btn[data-status="ongoing"] span');
            const completedSpan = querySel('.match-filter-btn[data-status="completed"] span');
            const resetTexts = () => { if (upcomingSpan) upcomingSpan.textContent = 'Upcoming'; if (ongoingSpan) ongoingSpan.textContent = 'Ongoing'; if (completedSpan) completedSpan.textContent = 'Completed'; };
            if (!currentUser || !userProfile.joinedTournaments) { resetTexts(); return; }
            const joinedTournamentIds = Object.keys(userProfile.joinedTournaments);
            if (joinedTournamentIds.length === 0) { resetTexts(); return; }
            try {
                const tournamentsSnapshot = await get(ref(db, 'tournaments'));
                const allTournaments = tournamentsSnapshot.val() || {};
                let upcomingCount = 0, ongoingCount = 0, completedCount = 0;
                joinedTournamentIds.forEach(tId => {
                    const tournament = allTournaments[tId];
                    if (tournament && tournament.status) {
                        switch(tournament.status.toLowerCase()) {
                            case 'upcoming': upcomingCount++; break;
                            case 'ongoing': case 'live': ongoingCount++; break;
                            case 'completed': completedCount++; break;
                        }
                    }
                });
                if (upcomingSpan) { upcomingSpan.textContent = upcomingCount > 0 ? `Upcoming (${upcomingCount})` : 'Upcoming'; }
                if (ongoingSpan) { ongoingSpan.textContent = ongoingCount > 0 ? `Ongoing (${ongoingCount})` : 'Ongoing'; }
                if (completedSpan) { completedSpan.textContent = completedCount > 0 ? `Completed (${completedCount})` : 'Completed'; }
            } catch (error) { console.error("Failed to update 'My Matches' counts:", error); resetTexts(); }
        }

        function copyToClipboard(targetSelector) { if (!targetSelector) { showCustomAlert('Error', 'Copy target not defined.'); return; } const targetElement = querySel(targetSelector); if (!targetElement) { showCustomAlert('Error', 'Element to copy from not found.'); return; } const textToCopy = targetElement.textContent.trim(); const nonCopyableTexts = ['N/A', 'Coming Soon', 'Hidden by Admin', 'Not updated yet', 'Not Found', 'Error']; if (!textToCopy || textToCopy.includes('placeholder') || nonCopyableTexts.some(txt => textToCopy.toLowerCase().includes(txt.toLowerCase()))) { showCustomAlert('Info', 'The information is not available to copy yet.'); return; } const fallbackCopy = () => { const textArea = document.createElement("textarea"); textArea.value = textToCopy; textArea.style.position = "fixed"; textArea.style.opacity = "0"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { const successful = document.execCommand('copy'); if (successful) { showCustomAlert('Success', 'Copied to clipboard!'); } else { showCustomAlert('Error', 'Could not copy text.'); } } catch (err) { console.error('Fallback copy failed', err); showCustomAlert('Error', 'Copying failed on your browser.'); } document.body.removeChild(textArea); }; if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(textToCopy).then(() => { showCustomAlert('Success', 'Copied to clipboard!'); }).catch(err => { console.error('Async Copy failed, trying fallback:', err); fallbackCopy(); }); } else { console.warn('Using fallback copy method.'); fallbackCopy(); } }
        function shareReferral(code) { if (!navigator.share) { showCustomAlert('Not Supported', 'Web Share is not available on your browser. Please copy the code manually.'); return; } if (!code || code === 'N/A') { showCustomAlert('Error', 'Referral code not available.'); return; } navigator.share({ title: 'Join Me on Gaming Tournament!', text: `Join using my referral code: ${code} & get rewards! App: ${window.location.origin}`, url: window.location.origin }).catch((error) => console.log('Error sharing', error)); }
        function generateReferralCode(length = 8) { const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let result = ''; for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length)); return result; }
        const removePlaceholders = (parentElement) => { if (!parentElement) return; parentElement.classList.remove('placeholder-glow'); parentElement.querySelectorAll('.placeholder').forEach(el => el.remove()); };
        
         function showSection(sectionId) {
             if (!auth || !sectionId || !elements.sections) { console.error("Cannot show section", sectionId); return; }
             const targetSection = getElement(sectionId); if (!targetSection) { console.error(`Section element "${sectionId}" not found.`); showSection(currentUser ? 'home-section' : 'login-section'); return; }
             const protectedSections = ['home-section', 'wallet-section', 'earnings-section', 'profile-section', 'tournaments-section', 'tournament-details-section', 'all-joinings-section', 'earnings-history-section'];
             const isLoggedIn = !!currentUser;
             if (protectedSections.includes(sectionId) && !isLoggedIn) { showSection('login-section'); return; }
             if (sectionId === 'login-section' && isLoggedIn) { showSection('home-section'); return; }
             elements.sections.forEach(sec => sec.classList.remove('active')); targetSection.classList.add('active'); currentSectionId = sectionId;
             updateHeaderForSection(sectionId);
             elements.bottomNavItems.forEach(item => { item.classList.toggle('active', item.dataset.section === sectionId); });
             
             animateSectionContent(sectionId);

             console.log(`Loading data for section: ${sectionId}`);
             switch (sectionId) {
                 case 'home-section': loadHomePageData(); break;
                 case 'wallet-section': loadWalletData(); break;
                 case 'profile-section': loadProfileData(); break;
                 case 'earnings-section': loadEarningsData(); break;
                 case 'tournaments-section': {
                    const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming';
                    filterTournaments(currentTournamentGameId, activeTab, isShowingMyMatches);
                    break;
                 }
             }
             if (sectionId === 'login-section') { hideAuthModal(); } 
             window.scrollTo(0, 0);
         }
         function updateHeaderForSection(sectionId) {
             const showBackButton = ['tournaments-section', 'tournament-details-section', 'all-joinings-section', 'earnings-history-section'].includes(sectionId);
             const defaultTitleVisible = !showBackButton;
             let gameTitleVisible = showBackButton;
             if (elements.headerBackBtn) elements.headerBackBtn.style.display = showBackButton ? 'inline-block' : 'none';
             if (elements.headerTitleContainer) elements.headerTitleContainer.style.display = defaultTitleVisible ? 'flex' : 'none';
             if (sectionId === 'tournaments-section') { if (isShowingMyMatches) { elements.headerGameTitle.textContent = 'My Matches'; } else if (currentTournamentGameId) { const gameName = appSettings?.games?.[currentTournamentGameId]?.name || 'Game'; elements.headerGameTitle.textContent = gameName; } } else if (sectionId === 'tournament-details-section') { elements.headerGameTitle.textContent = 'Contest Details'; } else if (sectionId === 'all-joinings-section') { elements.headerGameTitle.textContent = 'All Joinings'; } else if (sectionId === 'earnings-history-section') { elements.headerGameTitle.textContent = 'Earnings History'; } else { gameTitleVisible = false; }
             if (elements.headerGameTitle) elements.headerGameTitle.style.display = gameTitleVisible ? 'block' : 'none';
             if (defaultTitleVisible && elements.headerUserGreeting) { const nameToShow = userProfile?.displayName?.split(' ')[0] || (currentUser ? currentUser.email?.split('@')[0] : 'Guest') || 'Guest'; elements.headerUserGreeting.textContent = nameToShow; }
         }
         function updateGlobalUI(isLoggedIn) {
             if (elements.headerWalletChip) { elements.headerWalletChip.style.display = isLoggedIn ? 'flex' : 'none'; if (isLoggedIn) elements.headerWalletChip.onclick = () => showSection('wallet-section'); else elements.headerWalletChip.onclick = null; }
             if (!isLoggedIn && elements.headerUserGreeting) elements.headerUserGreeting.textContent = 'Guest';
             if (!isLoggedIn && elements.headerChipBalance) elements.headerChipBalance.textContent = '0';
             elements.bottomNavItems.forEach(item => { const section = item.dataset.section; item.style.display = (section === 'home-section' || isLoggedIn) ? 'flex' : 'none'; });
             if(!isLoggedIn) { elements.notificationList.innerHTML = '<p id="noNotificationsMessageEl" class="text-secondary text-center mt-4 p-3">Please log in to see notifications.</p>'; updateNotificationBadge(0); }
         }
         function populateUserInfo(user, profile) { 
            if (!user || !profile) return; 
            const displayName = profile.displayName || user.displayName || user.email?.split('@')[0] || 'User'; 
            const photoURL = profile.photoURL || user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName)}&background=ff8c00&color=fff&bold=true&size=80&rounded=true&length=2`; 
            const balance = (profile.balance || 0); 
            const winningCash = (profile.winningCash || 0); 
            const bonusCash = (profile.bonusCash || 0); 
            const totalEarnings = (profile.totalEarnings || 0); 
            const referralEarnings = (profile.referralEarnings || 0); 
            const totalMatches = profile.totalMatches || 0; 
            const wonMatches = profile.wonMatches || 0; 
            const formatCurrency = (amount) => `₹${amount.toFixed(2)}`; 
            if (elements.headerUserGreeting) elements.headerUserGreeting.textContent = displayName.split(' ')[0]; 
            if (elements.headerChipBalance) elements.headerChipBalance.textContent = Math.floor(balance); 
            if (elements.walletTotalBalance) { elements.walletTotalBalance.textContent = formatCurrency(balance); removePlaceholders(elements.walletTotalBalance.closest('.placeholder-glow')); } 
            if (elements.walletWinningCash) { elements.walletWinningCash.textContent = formatCurrency(winningCash); removePlaceholders(elements.walletWinningCash.closest('.placeholder-glow')); } 
            if (elements.walletBonusCash) { elements.walletBonusCash.textContent = formatCurrency(bonusCash); removePlaceholders(elements.walletBonusCash.closest('.placeholder-glow')); } 
            if (elements.withdrawModalBalance) elements.withdrawModalBalance.textContent = formatCurrency(winningCash); 
            if (elements.profileAvatar) elements.profileAvatar.src = photoURL; 
            if (elements.profileName) { elements.profileName.textContent = displayName; removePlaceholders(elements.profileName.closest('.placeholder-glow')); } 
            if (elements.profileEmail) { elements.profileEmail.textContent = user.email || 'N/A'; removePlaceholders(elements.profileEmail.closest('.placeholder-glow')); } 
            if (elements.profileTotalMatches) { elements.profileTotalMatches.textContent = totalMatches; removePlaceholders(elements.profileTotalMatches.closest('.placeholder-glow')); } 
            if (elements.profileWonMatches) { elements.profileWonMatches.textContent = wonMatches; removePlaceholders(elements.profileWonMatches.closest('.placeholder-glow')); } 
            if (elements.profileTotalEarnings) { elements.profileTotalEarnings.textContent = formatCurrency(totalEarnings); removePlaceholders(elements.profileTotalEarnings.closest('.placeholder-glow')); } 
            if (elements.earningsTotal) { elements.earningsTotal.textContent = formatCurrency(totalEarnings); removePlaceholders(elements.earningsTotal.closest('.placeholder-glow')); } 
            if (elements.earningsReferral) { elements.earningsReferral.textContent = formatCurrency(referralEarnings); removePlaceholders(elements.earningsReferral.closest('.placeholder-glow')); } 
            if (elements.modalUserEmail) elements.modalUserEmail.textContent = user.email || 'N/A';
            if (elements.notificationSwitch) { elements.notificationSwitch.checked = (profile.notificationsEnabled === false) ? false : true; }
        }
        function showAuthModal() { if (elements.authModalOverlay) elements.authModalOverlay.classList.add('visible'); }
        function hideAuthModal() { if (elements.authModalOverlay) elements.authModalOverlay.classList.remove('visible'); }
        function toggleLoginForm(showLogin) { if (!elements.emailLoginForm || !elements.emailSignupForm) return; clearStatusMessage(elements.loginStatusMessage); clearStatusMessage(elements.signupStatusMessage); elements.emailLoginForm.style.display = showLogin ? 'block' : 'none'; elements.emailSignupForm.style.display = showLogin ? 'none' : 'block'; elements.emailLoginForm.reset(); elements.emailSignupForm.reset(); showAuthModal(); }
        
        async function signUpWithEmail() {
            if (!auth) return;
            const em = elements.signupEmailInput.value.trim(); const pw = elements.signupPasswordInput.value; const cpw = elements.signupConfirmPasswordInput.value; const refCode = elements.signupReferralCodeInput.value.trim();
            if (!em || !pw || !cpw) { showStatusMessage(elements.signupStatusMessage, 'Fill required fields.', 'warning'); return; }
            if (pw !== cpw) { showStatusMessage(elements.signupStatusMessage, 'Passwords don\'t match.', 'warning'); return; }
            if (pw.length < 6) { showStatusMessage(elements.signupStatusMessage, 'Password min 6 chars.', 'warning'); return; }
            showLoader(true); clearStatusMessage(elements.signupStatusMessage); validReferrerUid = null;
            try {
                if (refCode) { const usersRef = ref(db, 'users'); const q = query(usersRef, orderByChild('referralCode'), equalTo(refCode)); const snapshot = await get(q); if (snapshot.exists()) { const referrerData = snapshot.val(); const referrerId = Object.keys(referrerData)[0]; validReferrerUid = referrerId; } }
                // MODIFICATION START: Removed email verification logic
                const userCredential = await createUserWithEmailAndPassword(auth, em, pw);
                // No sendEmailVerification call
                // No signOut call
                // onAuthStateChanged will handle the rest, just hide the modal
                hideAuthModal();
                // MODIFICATION END
            } catch (e) { console.error("Signup Error:", e); let m = `Signup failed.`; switch (e.code) { case 'auth/email-already-in-use': m = 'Email already registered.'; break; case 'auth/weak-password': m = 'Password too weak.'; break; case 'auth/invalid-email': m = 'Invalid email.'; break; default: m = `Error: ${e.message}`; } showStatusMessage(elements.signupStatusMessage, m, 'danger');
            } finally { showLoader(false); }
        }

        async function loginWithEmail() {
            if (!auth) return;
            const em = elements.loginEmailInput.value.trim(); const pw = elements.loginPasswordInput.value;
            if (!em || !pw) { showStatusMessage(elements.loginStatusMessage, 'Enter email & password.', 'warning'); return; }
            showLoader(true); clearStatusMessage(elements.loginStatusMessage);
            try {
                // MODIFICATION START: Removed email verification check
                const userCredential = await signInWithEmailAndPassword(auth, em, pw);
                // The onAuthStateChanged will now handle successful login without checking for verification
                // MODIFICATION END
            } catch (e) {
                console.error("Login Error:", e); let m = `Login failed.`;
                switch (e.code) {
                    case 'auth/user-not-found': case 'auth/wrong-password': case 'auth/invalid-credential': m = 'Invalid email or password.'; break;
                    case 'auth/invalid-email': m = 'Invalid email format.'; break;
                    case 'auth/too-many-requests': m = 'Too many attempts. Reset pass or wait.'; break;
                    case 'auth/network-request-failed': m = 'Network error.'; break;
                    case 'auth/user-disabled': m = 'Account disabled.'; break;
                    default: m = `Error: ${e.message}`;
                } showStatusMessage(elements.loginStatusMessage, m, 'danger');
            } finally { showLoader(false); }
        }

        async function resetPassword() { if (!auth) return; const em = elements.loginEmailInput.value.trim(); if (!em) { showStatusMessage(elements.loginStatusMessage, 'Enter email for password reset.', 'warning'); return; } showLoader(true); clearStatusMessage(elements.loginStatusMessage); try { await sendPasswordResetEmail(auth, em); showStatusMessage(elements.loginStatusMessage, 'Password reset email sent! Check inbox/spam.', 'success', false); } catch (e) { console.error("Reset Pass Error:", e); let m = `Failed to send email.`; switch (e.code) { case 'auth/user-not-found': case 'auth/invalid-email': m = 'Email not found.'; break; case 'auth/network-request-failed': m = 'Network error.'; break; default: m = `Error: ${e.message}`; } showStatusMessage(elements.loginStatusMessage, m, 'danger'); } finally { showLoader(false); } }
        async function logoutUser() { if (!auth) return; try { showLoader(true); await signOut(auth); } catch (e) { console.error("Sign Out Error:", e); showCustomAlert('Logout Failed', e.message); } finally { showLoader(false); } }
        
        async function handleAuthStateChange(user) {
             if (!auth || !db) { console.error("Firebase not ready"); showLoader(false); return; }
             showLoader(true);
             detachAllDbListeners(); currentUser = user; const localReferrerUid = validReferrerUid; validReferrerUid = null;
             if (user) {
                // MODIFICATION START: Removed email verification check
                // The block checking for user.emailVerified has been removed.
                // The app will proceed as if the user is always verified.
                // MODIFICATION END
                 hideAuthModal(); console.log("Auth State: Logged In", user.uid); const userRef = ref(db, 'users/' + user.uid);
                 try {
                     const snapshot = await get(userRef);
                     if (snapshot.exists()) { userProfile = snapshot.val(); } else {
                         console.log("New user, creating profile...");
                         const newUserProfile = { uid: user.uid, displayName: user.displayName || user.email?.split('@')[0] || 'User', email: user.email || null, photoURL: user.photoURL || null, balance: appSettings.newUserBalance || 0, winningCash: 0, bonusCash: appSettings.newUserBonus ?? 500, totalMatches: 0, wonMatches: 0, totalEarnings: 0, referralEarnings: 0, createdAt: Date.now(), referralCode: generateReferralCode(), joinedTournaments: {}, isAdmin: false, lastCheckedNotifications: 0, notificationsEnabled: true, ...(localReferrerUid && { referredBy: localReferrerUid }) };
                         await set(userRef, newUserProfile); userProfile = newUserProfile;
                         if (newUserProfile.bonusCash > 0) { await recordTransaction(user.uid, 'signup_bonus', newUserProfile.bonusCash, `Welcome Bonus`); }
                         if (localReferrerUid && appSettings.referralBonus > 0) {
                             const referrerRef = ref(db, `users/${localReferrerUid}`);
                             try { await runTransaction(referrerRef, (referrerData) => { if (referrerData) { referrerData.balance = (referrerData.balance || 0) + appSettings.referralBonus; referrerData.bonusCash = (referrerData.bonusCash || 0) + appSettings.referralBonus; referrerData.referralEarnings = (referrerData.referralEarnings || 0) + appSettings.referralBonus; } return referrerData; }); await recordTransaction(localReferrerUid, 'referral_bonus', appSettings.referralBonus, `Referral Bonus from ${newUserProfile.displayName || newUserProfile.email}`);
                             } catch (referrerError) { console.error("Error awarding referrer bonus:", referrerError); }
                         }
                     }
                     populateUserInfo(user, userProfile); setupRealtimeListeners(user.uid); updateGlobalUI(true);
                     const targetSection = (currentSectionId === 'login-section' || !getElement(currentSectionId)) ? 'home-section' : currentSectionId;
                     showSection(targetSection);
                 } catch (error) { console.error("Profile handling error:", error); showCustomAlert("Profile Error", "Error loading profile. Logging out. " + error.message); try { await logoutUser(); } catch (logoutErr) {} }
             } else { console.log("Auth State: Logged Out"); currentUser = null; userProfile = {}; updateGlobalUI(false); showSection('login-section'); }
             showLoader(false);
        }

        async function loadAppSettings() { console.log("Loading App Settings..."); try { const settingsRef = ref(db, 'settings'); const snapshot = await get(settingsRef); if (snapshot.exists()) { appSettings = snapshot.val() || {}; console.log("App Settings Loaded:", appSettings); if (appSettings.logoUrl && elements.appLogo) elements.appLogo.src = appSettings.logoUrl; if (appSettings.minWithdraw && elements.minWithdrawAmount) elements.minWithdrawAmount.textContent = appSettings.minWithdraw; const upiIdEl = document.querySelector('.phonepe-number'); if (upiIdEl) { upiIdEl.textContent = appSettings.upiDetails || '[!!! YOUR UPI ID/NUMBER HERE !!!]'; } const contactInfoPEl = document.querySelector('.modal-body p strong#modalUserEmailEl')?.closest('p'); if(contactInfoPEl && appSettings.supportContact) { contactInfoPEl.innerHTML = contactInfoPEl.innerHTML.replace('[!!! ADMIN CONTACT INFO HERE !!!]', appSettings.supportContact); } } else { console.warn("App Settings not found in database!"); appSettings = {}; } } catch (e) { console.error("Settings load failed", e); appSettings = {}; } }
        
        function loadHomePageData() {
            console.log("Loading Home Page Data...");
            if (!currentUser) { if (elements.gamesList) elements.gamesList.innerHTML = ''; if (elements.challengesGameList) elements.challengesGameList.innerHTML = ''; if(elements.promotionSlider?.querySelector('.swiper-wrapper')) elements.promotionSlider.querySelector('.swiper-wrapper').innerHTML = ''; return; }
            loadPromotions(); loadGames(elements.gamesList, 'contests'); loadGames(elements.challengesGameList, 'challenges');
        }
        
        function getYouTubeVideoId(url) { if (!url) return null; try { const urlObj = new URL(url); if (urlObj.hostname === 'youtu.be') return urlObj.pathname.slice(1); if (urlObj.hostname.includes('youtube.com')) return urlObj.searchParams.get('v'); } catch (e) { console.warn("Could not parse URL to get YouTube ID:", url); } return null; }
        function createYouTubeThumbnail(youtubeId) { return `<div class="youtube-thumbnail-container" data-youtube-id="${youtubeId}"><img src="https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg" alt="Promo Thumbnail" onerror="this.onerror=null; this.src='https://img.youtube.com/vi/${youtubeId}/hqdefault.jpg';"><div class="youtube-play-button"></div></div>`; }
        function createYouTubePlayer(youtubeId) { return `<iframe src="https://www.youtube.com/embed/${youtubeId}?autoplay=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><button class="close-video-btn">&times;</button>`; }
        
        function playYouTubeVideo(e) {
            const container = e.currentTarget; const slideElement = container.closest('.swiper-slide'); const videoId = container.dataset.youtubeId;
            if (slideElement && videoId) {
                slideElement.innerHTML = createYouTubePlayer(videoId);
                slideElement.querySelector('.close-video-btn').addEventListener('click', () => { resetYouTubeSlide(slideElement); if (swiperInstance && swiperInstance.autoplay && !swiperInstance.autoplay.running) { swiperInstance.autoplay.start(); } });
                if (swiperInstance && swiperInstance.autoplay) swiperInstance.autoplay.stop();
            }
        }
        function resetYouTubeSlide(slideElement) {
            const iframe = slideElement.querySelector('iframe'); if (!iframe) return; 
            const src = iframe.src; const videoIdMatch = src.match(/embed\/([^?]+)/);
            if (videoIdMatch && videoIdMatch[1]) { const videoId = videoIdMatch[1]; slideElement.innerHTML = createYouTubeThumbnail(videoId); slideElement.querySelector('.youtube-thumbnail-container').addEventListener('click', playYouTubeVideo); }
        }

        async function loadPromotions() {
            if (!elements.promotionSlider) return;
            const sliderWrapper = elements.promotionSlider.querySelector('.swiper-wrapper'); if (!sliderWrapper) return;
            sliderWrapper.classList.add('placeholder-glow'); sliderWrapper.innerHTML = `<div class="swiper-slide"><span class="placeholder" style="display: block; width: 100%; height: 100%; border-radius: 10px;"></span></div>`;
            try {
                const snapshot = await get(ref(db, 'promotions')); const promotions = snapshot.val() || {};
                const activePromotions = Object.values(promotions).filter(p => p && (p.imageUrl || p.videoUrl || p.youtubeUrl || p.actionLink));
                removePlaceholders(elements.promotionSlider); sliderWrapper.innerHTML = '';
                if (activePromotions.length > 0) {
                    elements.promotionSlider.style.display = 'block';
                    activePromotions.forEach(promo => {
                        const slide = document.createElement('div'); slide.className = 'swiper-slide';
                        const youtubeVideoId = getYouTubeVideoId(promo.youtubeUrl); const linkUrl = promo.actionLink;
                        if (youtubeVideoId) { slide.innerHTML = createYouTubeThumbnail(youtubeVideoId); } else if (promo.videoUrl) { slide.innerHTML = `<video src="${promo.videoUrl}" poster="${promo.imageUrl || ''}" controls muted loop playsinline alt="Promo Video"></video>`; } else if (promo.imageUrl) { const mediaContent = `<img src="${promo.imageUrl}" alt="Promo Image">`; slide.innerHTML = linkUrl ? `<a href="${linkUrl}" target="_blank" rel="noopener noreferrer">${mediaContent}</a>` : mediaContent; }
                        if (slide.innerHTML.trim() !== '') { sliderWrapper.appendChild(slide); }
                    });
                    sliderWrapper.querySelectorAll('.youtube-thumbnail-container').forEach(thumb => { thumb.addEventListener('click', playYouTubeVideo); });
                    if(sliderWrapper.children.length > 0) {
                        if (swiperInstance) swiperInstance.destroy(true, true);
                        swiperInstance = new Swiper(elements.promotionSlider, { 
                            loop: sliderWrapper.children.length > 1, 
                            autoplay: { delay: 4000, disableOnInteraction: false }, 
                            pagination: { el: '.swiper-pagination', clickable: true }, 
                            slidesPerView: 1, 
                            on: { 
                                slideChange: function () { 
                                    sliderWrapper.querySelectorAll('.swiper-slide').forEach(slide => { 
                                        if (slide.querySelector('iframe')) { resetYouTubeSlide(slide); } 
                                    }); 
                                    if (swiperInstance && swiperInstance.autoplay && !swiperInstance.autoplay.running) { 
                                        swiperInstance.autoplay.start(); 
                                    } 
                                } 
                            } 
                        });
                        swiperInstance.update();
                    } else { elements.promotionSlider.style.display = 'none'; }
                } else { elements.promotionSlider.style.display = 'none'; }
            } catch (e) { console.error("Promo load failed:", e); removePlaceholders(elements.promotionSlider); sliderWrapper.innerHTML = '<p class="text-danger text-center small p-3">Could not load promotions.</p>'; elements.promotionSlider.style.display = 'block'; }
        }

        async function loadGames(targetElement, type) {
            console.log(`Loading Games for type: ${type}`); if (!targetElement) return;
            targetElement.classList.add('placeholder-glow'); targetElement.innerHTML = `<div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div> <div class="col-6"><div class="game-card custom-card"><span class="placeholder d-block" style="height: 130px;"></span><span class="placeholder d-block mt-2 col-8 mx-auto" style="height: 20px;"></span></div></div>`;
            try {
                const tournamentsSnapshot = await get(ref(db, 'tournaments')); const allTournaments = tournamentsSnapshot.val() || {}; const upcomingTournamentCounts = {};
                for (const tId in allTournaments) { const t = allTournaments[tId]; if (t && t.status === 'upcoming' && t.gameId) { if (!upcomingTournamentCounts[t.gameId]) { upcomingTournamentCounts[t.gameId] = 0; } upcomingTournamentCounts[t.gameId]++; } }
                const gamesRef = ref(db, 'games'); const snapshot = await get(gamesRef); const games = snapshot.val() || {};
                const activeGames = Object.entries(games).filter(([, game]) => game.imageUrl && game.name).sort(([, gameA], [, gameB]) => (gameA.order || 0) - (gameB.order || 0));
                removePlaceholders(targetElement); targetElement.innerHTML = '';
                if (activeGames.length > 0) {
                    if (!appSettings.games) appSettings.games = {};
                    activeGames.forEach(([gameId, game]) => {
                        appSettings.games[gameId] = game; const count = upcomingTournamentCounts[gameId] || 0; const countHtml = count > 0 ? `<div class="game-tournament-count">${count}</div>` : '';
                        const col = document.createElement('div'); col.className = 'col-6';
                        col.innerHTML = `<div class="game-card custom-card" data-game-id="${gameId}" data-game-name="${game.name}">${countHtml}<img src="${game.imageUrl}" alt="${game.name}"><span>${game.name}</span></div>`;
                        col.querySelector('.game-card').addEventListener('click', () => { if (type === 'contests') { loadTournamentsForGame(gameId, game.name); } else { showCustomAlert('Coming Soon', `Challenges for ${game.name} will be available soon!`); } });
                        targetElement.appendChild(col);
                    });
                    animateSectionContent(elements.homeSection.id);
                } else { targetElement.innerHTML = '<p class="text-secondary text-center col-12">No games available.</p>'; }
            } catch (e) { console.error("Games load failed:", e); removePlaceholders(targetElement); targetElement.innerHTML = '<p class="text-danger text-center col-12">Could not load games.</p>'; }
        }
        
        function loadTournamentsForGame(gameId, gameName) { console.log(`Loading tournaments for game: ${gameName} (ID: ${gameId})`); if (!elements.tournamentsSection) return; isShowingMyMatches = false; currentTournamentGameId = gameId; setActiveTournamentTab('upcoming'); showSection('tournaments-section'); }
        function loadMyMatchesView(status) { if (!status) return; isShowingMyMatches = true; currentTournamentGameId = null; setActiveTournamentTab(status); showSection('tournaments-section'); }

        async function filterTournaments(gameId, status, userOnly = false) {
            console.log(`Filtering tournaments for game ${gameId || 'ALL'} with status ${status}. User only: ${userOnly}`); if (!elements.tournamentsListContainer) return;
            elements.tournamentsListContainer.innerHTML = `<div class="spinner-border text-primary mx-auto d-block mt-5" role="status"><span class="visually-hidden">Loading...</span></div>`; elements.noTournamentsMessage.style.display = 'none';
            try {
                const tournamentsRef = ref(db, 'tournaments'); const snapshot = await get(tournamentsRef); const allTournaments = snapshot.val() || {};
                const filteredTournaments = Object.entries(allTournaments).filter(([tId, t]) => {
                    let statusMatch = t.status && t.status.toLowerCase() === status.toLowerCase(); if (status.toLowerCase() === 'ongoing') { statusMatch = t.status && (t.status.toLowerCase() === 'ongoing' || t.status.toLowerCase() === 'live'); }
                    const gameMatch = !gameId || t.gameId === gameId; const userMatch = !userOnly || (userProfile.joinedTournaments && userProfile.joinedTournaments[tId]);
                    return statusMatch && gameMatch && userMatch;
                }).sort(([, tA], [, tB]) => (tA.startTime || 0) - (tB.startTime || 0));
                elements.tournamentsListContainer.innerHTML = '';
                if (filteredTournaments.length > 0) { 
                    filteredTournaments.forEach((args) => { 
                        const card = createTournamentCardElement(...args); 
                        elements.tournamentsListContainer.appendChild(card);
                    });
                    animateSectionContent(elements.tournamentsSection.id);
                } else { 
                    elements.noTournamentsMessage.style.display = 'block'; 
                    elements.noTournamentsMessage.textContent = `No ${status} tournaments found.`; 
                }
            } catch (e) { console.error(`Tournaments filter failed (${status}):`, e); elements.tournamentsListContainer.innerHTML = '<p class="text-danger text-center mt-4">Could not load tournaments.</p>'; elements.noTournamentsMessage.style.display = 'none'; }
        }
        
        function createTournamentCardElement(tId, t) {
            const card = document.createElement('div'); card.className = 'tournament-card'; card.dataset.tournamentId = tId;
            const pPool = t.winPrize || 0; const eFee = t.entryFee || 0; const pkPrize = t.perKillPrize || 0;
            const registeredPlayers = t.registeredPlayers || {}; let registeredCount = 0;
            Object.values(registeredPlayers).forEach(registration => { if (registration && Array.isArray(registration.team) && registration.team.length > 0) { registeredCount += registration.team.length; } else if (registration) { registeredCount += 1; } });
            const maxP = t.totalSlots || 100; const spotsL = Math.max(0, maxP - registeredCount); const progP = maxP > 0 ? Math.min(100, (registeredCount / maxP) * 100) : 0;
            let sTimeFormatted = 'Time: TBD'; if (t.startDate && t.startTime) { try { const date = new Date(`${t.startDate}T${t.startTime}`); if (!isNaN(date.getTime())) { sTimeFormatted = `Time: ${date.toLocaleString('en-IN', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true })}`; } } catch (e) { console.warn("Date parse error for", tId, e); } }
            const gameData = appSettings?.games?.[t.gameId]; let headerImageUrl = gameData?.imageUrl || 'https://via.placeholder.com/400x160?text=No+Image';
            if (gameData && gameData.maps && t.map) { const mapsObject = gameData.maps; const mapData = Object.values(mapsObject).find(m => m.name === t.map); if (mapData && mapData.imageUrl) { headerImageUrl = mapData.imageUrl; } }
            card.innerHTML = `<img class="card-header-image" src="${headerImageUrl}" alt="${t.name || 'Tournament Image'}"><div class="card-content"><div class="info-grid"><div class="info-box"> <span>Prize Pool</span> <strong>₹${pPool}</strong> </div><div class="info-box"> <span>Entry Fee</span> <strong>${eFee > 0 ? `₹${eFee}` : 'Free'}</strong> </div><div class="info-box"> <span>Per Kill</span> <strong>₹${pkPrize}</strong> </div></div><h3 class="card-title">${t.name || 'Tournament'}</h3><p class="card-time">${sTimeFormatted}</p><div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;"><span class="spots-text">Only <strong>${spotsL}</strong> spots left</span><span class="spots-text"><strong>${registeredCount}/${maxP}</strong></span></div><div class="progress" style="height: 8px; margin-top: 8px;"><div class="progress-bar" role="progressbar" style="width: ${progP}%"></div></div><button class="btn btn-join w-100">View Details</button></div>`;
            card.addEventListener('click', (e) => { showTournamentDetails(tId); });
            return card;
        }

        async function showTournamentDetails(tournamentId) {
            if (!tournamentId) return; showLoader(true); lastTournamentDetailsId = tournamentId;
            try {
                const tournamentSnapshot = await get(ref(db, `tournaments/${tournamentId}`));
                if (!tournamentSnapshot.exists()) { showCustomAlert('Error', 'Tournament details not found!'); showLoader(false); return; }
                const t = tournamentSnapshot.val(); if (!t.id) t.id = tournamentId;
                const game = appSettings.games?.[t.gameId] || { name: 'Unknown Game' };
                const rulesHtml = (t.rules || 'No special rules.').split('\n').filter(rule => rule.trim() !== '').map((rule, index) => `<div class="rule-item animated-item" style="animation-delay:${index * 50}ms"><strong>Rule ${index + 1}:</strong> ${rule.trim()}</div>`).join('');
                let prizeDescHtml = ''; if (t.prizeDescription) { prizeDescHtml = `<div class="details-section-title">Prize Description</div><div class="details-grid-item" style="text-align: left; padding: 15px; grid-column: 1 / -1;">${t.prizeDescription.replace(/\n/g, '<br>')}</div>`; }
                const isJ = currentUser && userProfile?.joinedTournaments?.[t.id];
                const registeredPlayers = t.registeredPlayers || {}; let registeredCount = 0;
                Object.values(registeredPlayers).forEach(registration => { if (registration && Array.isArray(registration.team) && registration.team.length > 0) { registeredCount += registration.team.length; } else if (registration) { registeredCount += 1; } });
                const spotsL = Math.max(0, (t.totalSlots || 100) - registeredCount); let joinButtonHtml = `<button class="btn btn-join-details" disabled>Closed</button>`;
                if (t.status && t.status.toLowerCase() === 'upcoming') { if (isJ) { joinButtonHtml = `<button class="btn" disabled>Already Joined</button>`; } else if (spotsL > 0) { joinButtonHtml = `<button class="btn btn-join-details" data-tournament-id="${t.id}" data-fee="${t.entryFee || 0}">Join Match</button>`; } else { joinButtonHtml = `<button class="btn btn-join-details" disabled>Match Full</button>`; } }
                let roomDetailsHtml = ''; if (isJ) { const defaultText = 'Coming Soon'; const roomId = t.showIdPass ? (t.roomId || defaultText) : defaultText; const roomPass = t.showIdPass ? (t.roomPass || defaultText) : defaultText; roomDetailsHtml = `<div class="room-details-container animated-item"><h5 class="details-section-title" style="margin-top: 0;">Room Details</h5><div class="room-detail-item"><span>ID:</span><strong id="roomDetailsIdEl">${roomId}</strong><button class="btn-copy-icon copy-btn" data-target="#roomDetailsIdEl" title="Copy Room ID"><i class="bi bi-clipboard"></i></button></div><div class="room-detail-item"><span>PASS:</span><strong id="roomDetailsPassEl">${roomPass}</strong><button class="btn-copy-icon copy-btn" data-target="#roomDetailsPassEl" title="Copy Password"><i class="bi bi-clipboard"></i></button></div></div>`; }
                
                let sTimeFormatted = 'Schedule Not Available';
                if (t.startDate && t.startTime) {
                    const date = new Date(`${t.startDate}T${t.startTime}`);
                    if (!isNaN(date.getTime())) {
                        sTimeFormatted = date.toLocaleString('en-IN', { day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true });
                    }
                }

                const detailsHtml = `${roomDetailsHtml}<div class="details-header animated-item" style="animation-delay:50ms"><h4>${game.name} - ${t.map || 'Default'} MAP</h4><p>ID#${t.id.substring(t.id.length - 5)}</p></div><div class="details-grid animated-item" style="animation-delay:100ms"><div class="details-grid-item"><span>Team</span><strong>${t.mode || 'N/A'}</strong></div><div class="details-grid-item"><span>Mode</span><strong>${t.perspective || 'TPP'}</strong></div><div class="details-grid-item"><span>Map</span><strong>${t.map || 'N/A'}</strong></div><div class="details-grid-item"><span>Entry Fee</span><strong>${(t.entryFee || 0) > 0 ? `₹${t.entryFee}` : 'Free'}</strong></div></div><div class="details-grid-item animated-item" style="grid-column: 1 / -1; margin-bottom: 20px; animation-delay:150ms"><span>Match Schedule</span><strong>${sTimeFormatted}</strong></div><div class="details-section-title animated-item" style="animation-delay:200ms">Prize Details</div><div class="details-grid animated-item" style="animation-delay:250ms"><div class="details-grid-item"><span>Prize Pool</span><strong>₹${t.winPrize || 0}</strong></div><div class="details-grid-item"><span>Per Kill</span><strong>₹${t.perKillPrize || 0}</strong></div></div>${prizeDescHtml ? prizeDescHtml.replace('<div class="details-section-title">Prize Description</div>', '') : ''}<div class="details-section-title animated-item" style="animation-delay:300ms">Match Rules</div><div class="rules-container">${rulesHtml}</div><div class="details-footer-actions animated-item" style="animation-delay:350ms">${joinButtonHtml}<button class="btn btn-view-joinings">View All Joinings</button></div>`;
                const detailsSection = getElement('tournament-details-section'); detailsSection.innerHTML = detailsHtml; showSection('tournament-details-section');
                const joinBtn = detailsSection.querySelector('.btn-join-details'); if (joinBtn && !joinBtn.disabled) { joinBtn.addEventListener('click', handleJoinTournamentClick); }
                detailsSection.querySelector('.btn-view-joinings').addEventListener('click', () => showAllJoinings(tournamentId));
            } catch (error) { console.error("Error showing tournament details:", error); showCustomAlert('Error', 'Could not load tournament details.'); } finally { showLoader(false); }
        }
        
        async function showAllJoinings(tournamentId) {
            if (!tournamentId) return; const joiningsSection = elements.allJoiningsSection; joiningsSection.innerHTML = '<div class="text-center p-5"><div class="spinner-border"></div></div>'; showSection('all-joinings-section');
            try {
                const joiningsRef = ref(db, `tournaments/${tournamentId}/registeredPlayers`); const snapshot = await get(joiningsRef);
                if (!snapshot.exists()) { joiningsSection.innerHTML = '<p class="text-center text-secondary p-5">No one has joined this tournament yet.</p>'; return; }
                const registeredPlayers = snapshot.val(); let allPlayersList = [];
                for (const uid in registeredPlayers) {
                    const registration = registeredPlayers[uid]; if (registration.team && Array.isArray(registration.team)) {
                        registration.team.forEach(player => { if (player.slotId) { if (player.slotId.startsWith('SLOT_')) { allPlayersList.push({ team: 'Solo', pos: '-', ign: player.ign || 'N/A', igid: player.igid || 'N/A' }); } else { const match = player.slotId.match(/T(\d+)P(\w)/); if (match) { allPlayersList.push({ team: parseInt(match[1], 10), pos: match[2], ign: player.ign || 'N/A', igid: player.igid || 'N/A' }); } } } });
                    }
                }
                if (allPlayersList.length === 0) { joiningsSection.innerHTML = '<p class="text-center text-secondary p-5">No players found in the joinings list.</p>'; return; }
                allPlayersList.sort((a, b) => { if (a.team === 'Solo' && b.team !== 'Solo') return 1; if (a.team !== 'Solo' && b.team === 'Solo') return -1; if (a.team !== 'Solo' && b.team !== 'Solo') { if (a.team !== b.team) return a.team - b.team; return a.pos.localeCompare(b.pos); } return (a.ign || '').localeCompare(b.ign || ''); });
                let listHtml = `<div class="joinings-list-header animated-item"><div>Team No.</div><div>Pos.</div><div>In Game Name</div><div>In Game ID</div></div><div id="joinings-list-container">`;
                allPlayersList.forEach((player, index) => { listHtml += `<div class="joining-item animated-item" style="animation-delay:${index*50}ms"><div>${player.team}</div><div>${player.pos}</div><div>${player.ign}</div><div>${player.igid}</div></div>`; });
                listHtml += '</div>'; joiningsSection.innerHTML = listHtml;
            } catch (error) { console.error("Error fetching joinings:", error); joiningsSection.innerHTML = '<p class="text-center text-danger p-5">Could not load player list.</p>'; }
        }

        function loadWalletData() { console.log("Loading Wallet Data..."); if (!currentUser) return; loadRecentTransactions(); }
        function loadProfileData() { console.log("Loading Profile Data..."); if (!currentUser) return; if (userProfile?.displayName) { removePlaceholders(elements.profileName?.closest('.placeholder-glow')); removePlaceholders(elements.profileEmail?.closest('.placeholder-glow')); removePlaceholders(elements.profileTotalMatches?.closest('.placeholder-glow')); removePlaceholders(elements.profileWonMatches?.closest('.placeholder-glow')); removePlaceholders(elements.profileTotalEarnings?.closest('.placeholder-glow')); } }
        function loadEarningsData() { console.log("Loading Earnings Data..."); if (!currentUser) return; if (typeof userProfile?.totalEarnings !== 'undefined') removePlaceholders(elements.earningsTotal?.closest('.placeholder-glow')); if (typeof userProfile?.referralEarnings !== 'undefined') removePlaceholders(elements.earningsReferral?.closest('.placeholder-glow')); }
        async function recordTransaction(userId, type, amount, description, details = {}) { if (!userId) return; const transactionRef = ref(db, `transactions/${userId}`); const newTransaction = { type, amount, description, timestamp: Date.now(), ...details }; try { await push(transactionRef, newTransaction); console.log(`Transaction recorded: ${type}, Amount: ${amount}`); } catch (e) { console.error("Transaction record failed:", e); } }
        
        async function loadRecentTransactions() {
            console.log("Loading Recent Transactions..."); if (!currentUser || !elements.recentTransactionsList) return; const limit = 5;
            elements.recentTransactionsList.innerHTML = ''; elements.recentTransactionsList.classList.add('placeholder-glow');
            for (let i = 0; i < 3; i++) { elements.recentTransactionsList.innerHTML += `<div class="transaction-item placeholder-glow"><div class="transaction-details"><div class="desc"><span class="placeholder col-7"></span></div><div class="date"><span class="placeholder col-9"></span></div></div><div class="transaction-amount"><span class="placeholder col-3"></span></div></div>`; }
            if (elements.noTransactionsMessage) { elements.noTransactionsMessage.style.display = 'block'; elements.noTransactionsMessage.textContent = 'Loading transactions...'; }
            try {
                const transRef = query(ref(db, `transactions/${currentUser.uid}`), limitToLast(limit)); const s = await get(transRef); const transactions = s.val() || {};
                const sortedT = Object.values(transactions).sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                removePlaceholders(elements.recentTransactionsList); elements.recentTransactionsList.innerHTML = '';
                if (sortedT.length > 0) {
                    if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none';
                    sortedT.forEach(t => {
                        const item = document.createElement('div'); item.className = 'transaction-item';
                        const isCr = t.amount > 0; const amt = `${isCr ? '+' : ''}₹${Math.abs(t.amount || 0).toFixed(2)}`;
                        const time = t.timestamp ? new Date(t.timestamp).toLocaleString('en-IN', { day: 'numeric', month: 'short', year: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }) : 'N/A';
                        item.innerHTML = `<div class="transaction-details"><div class="desc">${t.description || t.type || 'Transaction'}</div><div class="date">${time}</div></div><div class="transaction-amount ${isCr ? 'credit' : 'debit'}">${amt}</div>`;
                        elements.recentTransactionsList.appendChild(item);
                    });
                    animateSectionContent(elements.walletSection.id);
                } else if (elements.noTransactionsMessage) { elements.noTransactionsMessage.style.display = 'block'; elements.noTransactionsMessage.textContent = 'No recent transactions.'; }
            } catch (e) { console.error("Transactions load failed:", e); removePlaceholders(elements.recentTransactionsList); elements.recentTransactionsList.innerHTML = '<p class="text-danger text-center">Could not load transactions.</p>'; if (elements.noTransactionsMessage) elements.noTransactionsMessage.style.display = 'none'; }
        }

        async function showEarningsHistory() {
            if (!currentUser) return; showSection('earnings-history-section');
            const historySection = elements.earningsHistorySection; historySection.innerHTML = `<h2 class="section-title">Earnings History</h2><div class="text-center p-4"><div class="spinner-border text-primary"></div></div>`;
            try {
                const transRef = ref(db, `transactions/${currentUser.uid}`); const snapshot = await get(transRef);
                if (!snapshot.exists()) { historySection.innerHTML = `<h2 class="section-title">Earnings History</h2><p class="text-secondary text-center mt-4">No earnings history found.</p>`; return; }
                const allTransactions = snapshot.val();
                const earningsTransactions = Object.values(allTransactions).filter(t => t.amount > 0 && (t.type.includes('winnings') || t.type.includes('bonus') || t.type.includes('referral') || t.type.includes('reward'))).sort((a, b) => b.timestamp - a.timestamp);
                let listHtml = `<h2 class="section-title">Earnings History</h2>`;
                if (earningsTransactions.length > 0) { earningsTransactions.forEach((t,index) => { const time = new Date(t.timestamp).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }); const amt = `+₹${Math.abs(t.amount || 0).toFixed(2)}`; listHtml += `<div class="transaction-item animated-item" style="animation-delay:${index * 50}ms"><div class="transaction-details"><div class="desc">${t.description || t.type}</div><div class="date">${time}</div></div><div class="transaction-amount credit">${amt}</div></div>`; }); } else { listHtml += `<p class="text-secondary text-center mt-4">No earnings history found.</p>`; }
                historySection.innerHTML = listHtml;
            } catch (error) { console.error("Failed to load earnings history:", error); historySection.innerHTML = `<h2 class="section-title">Earnings History</h2><p class="text-danger text-center mt-4">Could not load history. Please try again.</p>`; }
        }

        function updateSlotSelectionFooter() { const selectedCount = elements.slotSelectionGridContainer.querySelectorAll('.slot-btn.selected').length; const btn = elements.confirmJoinSlotBtn; if (selectedCount > 0) { btn.disabled = false; btn.textContent = `Next (${selectedCount} selected)`; } else { btn.disabled = true; btn.textContent = 'Next'; } }

        async function openSlotSelectionModal(tId, fee, tData) {
            if (!elements.selectPositionModalInstance) return;
            const mode = tData.mode?.toLowerCase() || 'squad'; const selectionLimit = { solo: 1, duo: 2, squad: 4 }[mode] || 1; let selections = []; 
            const totalSlots = tData.totalSlots || 100; const registeredPlayers = tData.registeredPlayers || {}; const bookedSlots = new Set();
            Object.values(registeredPlayers).forEach(player => { const playerSlots = Array.isArray(player.team) ? player.team.map(p => p.slotId) : []; playerSlots.forEach(s => { if (s) bookedSlots.add(s); }); });
            elements.slotSelectionGridContainer.innerHTML = ''; elements.slotSelectionGridContainer.style.gridTemplateColumns = '1fr';
            if (mode === 'squad') {
                elements.slotSelectionGridContainer.style.gridTemplateColumns = '1fr 2.5fr'; const teams = Math.ceil(totalSlots / 4);
                let teamLabelsHtml = '<div class="grid-header">Team</div>'; let slotsHtml = `<div class="player-labels-header" style="grid-template-columns: repeat(4, 1fr);"><div>A</div><div>B</div><div>C</div><div>D</div></div>`;
                for (let i = 1; i <= teams; i++) {
                    teamLabelsHtml += `<div class="team-label">Team ${i}</div>`; slotsHtml += `<div class="slot-buttons-row" style="grid-template-columns: repeat(4, 1fr);">`;
                    for (let j = 1; j <= 4; j++) { const playerLetter = String.fromCharCode(64 + j); const slotId = `T${i}P${playerLetter}`; const isSlotBooked = bookedSlots.has(slotId); if (isSlotBooked) { slotsHtml += `<button class="slot-btn booked" disabled>${playerLetter}</button>`; } else { slotsHtml += `<button class="slot-btn available" data-slot-id="${slotId}" data-player-number="${playerLetter}">${playerLetter}</button>`; } }
                    slotsHtml += '</div>';
                } elements.slotSelectionGridContainer.innerHTML = `<div class="team-labels-col">${teamLabelsHtml}</div><div class="slots-data-col">${slotsHtml}</div>`;
            } else if (mode === 'duo') {
                elements.slotSelectionGridContainer.style.gridTemplateColumns = '1fr 1.8fr'; const teams = Math.ceil(totalSlots / 2);
                let teamLabelsHtml = '<div class="grid-header">Team</div>'; let slotsHtml = `<div class="player-labels-header" style="grid-template-columns: repeat(2, 1fr);"><div>A</div><div>B</div></div>`;
                for (let i = 1; i <= teams; i++) {
                    teamLabelsHtml += `<div class="team-label">Team ${i}</div>`; slotsHtml += `<div class="slot-buttons-row" style="grid-template-columns: repeat(2, 1fr);">`;
                    for (let j = 1; j <= 2; j++) { const playerLetter = String.fromCharCode(64 + j); const slotId = `T${i}P${playerLetter}`; const isSlotBooked = bookedSlots.has(slotId); if (isSlotBooked) { slotsHtml += `<button class="slot-btn booked" disabled>${playerLetter}</button>`; } else { slotsHtml += `<button class="slot-btn available" data-slot-id="${slotId}" data-player-number="${playerLetter}">${playerLetter}</button>`; } }
                    slotsHtml += '</div>';
                } elements.slotSelectionGridContainer.innerHTML = `<div class="team-labels-col">${teamLabelsHtml}</div><div class="slots-data-col">${slotsHtml}</div>`;
            } else {
                const slotsContainer = document.createElement('div'); slotsContainer.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; max-height: 40vh; overflow-y: auto; padding: 5px;';
                for (let i = 1; i <= totalSlots; i++) { const slotId = `SLOT_${i}`; const isSlotBooked = bookedSlots.has(slotId); const button = document.createElement('button'); button.textContent = i; if (isSlotBooked) { button.className = 'slot-btn booked'; button.disabled = true; } else { button.className = 'slot-btn available'; button.dataset.slotId = slotId; button.dataset.playerNumber = i; } slotsContainer.appendChild(button); }
                elements.slotSelectionGridContainer.appendChild(slotsContainer);
            }
            updateSlotSelectionFooter(); elements.selectPositionModalInstance.show();
            const allAvailableSlots = elements.slotSelectionGridContainer.querySelectorAll('.slot-btn.available');
            allAvailableSlots.forEach(btn => {
                btn.addEventListener('click', () => {
                    const slotId = btn.dataset.slotId; const selectionIndex = selections.indexOf(slotId);
                    if (selectionIndex > -1) { selections.splice(selectionIndex, 1); btn.classList.remove('selected'); } else { if (selections.length >= selectionLimit) { showCustomAlert('Limit Reached', `You can only select a maximum of ${selectionLimit} position(s) for this match.`); return; } selections.push(slotId); btn.classList.add('selected'); }
                    document.querySelectorAll('.slot-btn.selected').forEach(selectedBtn => { const id = selectedBtn.dataset.slotId; const number = selections.indexOf(id) + 1; if (selectionLimit > 1) { selectedBtn.innerHTML = `<span>${number}</span>`; } });
                    allAvailableSlots.forEach(b => { if (!selections.includes(b.dataset.slotId)) { b.innerHTML = b.dataset.playerNumber; b.classList.remove('selected'); } });
                    updateSlotSelectionFooter();
                });
            });
            const newJoinBtn = elements.confirmJoinSlotBtn.cloneNode(true); elements.confirmJoinSlotBtn.parentNode.replaceChild(newJoinBtn, elements.confirmJoinSlotBtn); elements.confirmJoinSlotBtn = newJoinBtn;
            newJoinBtn.addEventListener('click', () => { if (selections.length === 0) { showCustomAlert("Error", "Please select at least one position."); return; } elements.selectPositionModalInstance.hide(); showAddInfoModal(tId, fee, selections, tData); });
        }
        
        function openPlayerDetailsModal(slotId, buttonElement) {
            clearStatusMessage(elements.playerDetailsStatusMessageEl); let labelText;
            if (slotId.startsWith('SLOT_')) { const slotNumber = slotId.split('_')[1]; labelText = `Details for Slot ${slotNumber}`; } else { const [_, team, player] = slotId.match(/T(\d+)P(\w)/); labelText = `Details for Team ${team} - ${player}`; }
            elements.playerDetailsModalLabel.textContent = labelText;
            elements.inGameNameInput.value = temporaryTeamInfo[slotId]?.ign || ''; elements.inGameIdInput.value = temporaryTeamInfo[slotId]?.igid || '';
            elements.playerDetailsOverlayEl.classList.add('visible');
            const hide = () => elements.playerDetailsOverlayEl.classList.remove('visible');
            elements.savePlayerDetailsBtn.onclick = () => {
                const ign = elements.inGameNameInput.value.trim(); const igid = elements.inGameIdInput.value.trim();
                if (!ign || !igid) { showStatusMessage(elements.playerDetailsStatusMessageEl, 'Please fill both fields.', 'warning', true); return; }
                temporaryTeamInfo[slotId] = { ign, igid }; buttonElement.textContent = ign; buttonElement.classList.add('info-added');
                checkAllInfoAdded(); hide();
            };
            elements.playerDetailsCloseBtn.onclick = hide; elements.playerDetailsCancelBtn.onclick = hide;
        }

        function checkAllInfoAdded() { const allButtons = elements.infoModalSlotsList.querySelectorAll('.btn-add-info'); const allAdded = Array.from(allButtons).every(btn => btn.classList.contains('info-added')); elements.infoModalConfirmJoinBtn.disabled = !allAdded; }

        async function showAddInfoModal(tId, feePerSlot, selectedSlotIds, tData) {
            if (!elements.addInfoModalEl) return; temporaryTeamInfo = {};
            let confirmBtnInDom = getElement('infoModalConfirmJoinBtn'); confirmBtnInDom.disabled = true; confirmBtnInDom.innerHTML = 'Confirm & Join'; clearStatusMessage(elements.infoModalStatusMessageEl);
            const totalFee = feePerSlot * selectedSlotIds.length;
            elements.infoModalWalletBalance.textContent = `₹${(userProfile.balance || 0).toFixed(2)}`; elements.infoModalEntryFee.textContent = `₹${feePerSlot.toFixed(2)}`; elements.infoModalTotalAmount.textContent = `₹${totalFee.toFixed(2)}`;
            const slotsListContainer = elements.infoModalSlotsList; slotsListContainer.innerHTML = '';
            selectedSlotIds.forEach((slotId) => {
                let labelText; if (slotId.startsWith('SLOT_')) { const slotNumber = slotId.split('_')[1]; labelText = `Slot ${slotNumber}`; } else { const [_, team, player] = slotId.match(/T(\d+)P(\w)/); labelText = `Team ${team} - ${player}`; }
                const listItem = document.createElement('div'); listItem.className = 'd-flex align-items-center justify-content-between mb-2';
                listItem.innerHTML = `<div class="me-3"><span class="text-secondary">${labelText}</span></div><div class="flex-grow-1" style="max-width: 50%;"><button class="btn-add-info" data-slot-id="${slotId}">Add Info</button></div>`;
                slotsListContainer.appendChild(listItem);
            });
            slotsListContainer.querySelectorAll('.btn-add-info').forEach(btn => { btn.addEventListener('click', (e) => { openPlayerDetailsModal(e.currentTarget.dataset.slotId, e.currentTarget); }); });
            elements.addInfoModalEl.classList.add('visible');
            const newConfirmBtn = confirmBtnInDom.cloneNode(true); confirmBtnInDom.parentNode.replaceChild(newConfirmBtn, confirmBtnInDom); elements.infoModalConfirmJoinBtn = newConfirmBtn;
            const cancelHandler = () => elements.addInfoModalEl.classList.remove('visible');
            const confirmHandler = async () => {
                try {
                    const teamData = selectedSlotIds.map(slotId => { if (!temporaryTeamInfo[slotId]) { throw new Error(`Details are missing for slot ${slotId}.`); } return { slotId, ign: temporaryTeamInfo[slotId].ign, igid: temporaryTeamInfo[slotId].igid }; });
                    newConfirmBtn.disabled = true; newConfirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Joining...';
                    await processJoin(tId, totalFee, teamData, tData.name);
                } catch (error) { console.error("Join confirmation error:", error); showCustomAlert("Error", error.message); newConfirmBtn.disabled = false; newConfirmBtn.innerHTML = 'Confirm & Join'; }
            };
            elements.infoModalCancelBtn.onclick = cancelHandler; newConfirmBtn.addEventListener('click', confirmHandler);
        }
        
        async function handleJoinTournamentClick(event) {
             if (!currentUser) { showCustomAlert("Login Required", "You need to log in to join a tournament."); toggleLoginForm(true); return; }
            const btn = event.currentTarget; const tId = btn.dataset.tournamentId; const fee = parseFloat(btn.dataset.fee || 0);
            showLoader(true); const tRef = ref(db, `tournaments/${tId}`); const tSnapshot = await get(tRef);
            if (!tSnapshot.exists()) { showLoader(false); showCustomAlert('Error', 'This tournament is no longer available.'); return; }
            const tData = tSnapshot.val(); showLoader(false);
            openSlotSelectionModal(tId, fee, tData);
        }
        
        async function processJoin(tId, totalFee, teamData, tName) {
            showLoader(true); if (elements.addInfoModalEl) elements.addInfoModalEl.classList.remove('visible'); const uRef = ref(db, `users/${currentUser.uid}`); let userTxResult;
            try {
                userTxResult = await runTransaction(uRef, (profileData) => { if (!profileData) { return; } if ((profileData.balance || 0) < totalFee) { return; } if (profileData.joinedTournaments && profileData.joinedTournaments[tId]) { return; } profileData.balance = (profileData.balance || 0) - totalFee; if (!profileData.joinedTournaments) { profileData.joinedTournaments = {}; } profileData.joinedTournaments[tId] = true; return profileData; });
                if (!userTxResult.committed) { const currentProfile = userTxResult.snapshot.val(); if (currentProfile && currentProfile.joinedTournaments && currentProfile.joinedTournaments[tId]) { throw new Error("You have already joined this tournament."); } if (currentProfile && (currentProfile.balance || 0) < totalFee) { throw new Error("Insufficient balance."); } throw new Error("Could not update your profile. Please try again."); }
            } catch (e) { showLoader(false); showCustomAlert('Join Failed', e.message); return; }
            const tRegRef = ref(db, `tournaments/${tId}/registeredPlayers/${currentUser.uid}`); const registrationData = { joinedAt: serverTimestamp(), displayName: userProfile.displayName || 'User' }; if (teamData && teamData.length > 0) { registrationData.team = teamData; }
            try {
                await set(tRegRef, registrationData);
                const joinDescription = `Joined: ${tName || 'Tournament'}` + (teamData ? ` (${teamData.length} slots)` : '');
                await recordTransaction(currentUser.uid, 'tournament_join', -totalFee, joinDescription, { tournamentId: tId, team: teamData || null });
                showCustomAlert('Success', `You've joined the tournament! ₹${totalFee.toFixed(2)} was deducted.`);
                if (currentSectionId === 'tournament-details-section') showTournamentDetails(tId); else if (currentSectionId === 'tournaments-section') { const activeTab = querySel('.tournament-tabs .tab-item.active')?.dataset.status || 'upcoming'; filterTournaments(currentTournamentGameId, activeTab, isShowingMyMatches); } if (currentSectionId === 'wallet-section') loadRecentTransactions();
            } catch (e) {
                console.error("FATAL: Join failed at tournament registration step:", e); showCustomAlert('Join Failed', `A server error occurred: ${e.message}. We will now refund your entry fee.`);
                const refundTx = await runTransaction(uRef, (profileData) => { if (profileData) { profileData.balance = (profileData.balance || 0) + totalFee; if (profileData.joinedTournaments) { delete profileData.joinedTournaments[tId]; } } return profileData; });
                if (refundTx.committed) { await recordTransaction(currentUser.uid, 'join_failed_refund', totalFee, `Refund Failed Join: ${tName || 'Tournament'}`); showCustomAlert("Refund Issued", "The join failed, but your fee was automatically refunded to your wallet."); } else { console.error("CRITICAL: FAILED TO AUTOMATICALLY REFUND BALANCE!"); showCustomAlert(`CRITICAL ERROR`, `Join failed, and we could not automatically refund your balance (₹${totalFee.toFixed(2)})! Please contact support immediately.`); }
            } finally { showLoader(false); }
        }

        function handleWithdrawClick() { if (!currentUser || !elements.withdrawModalInstance) return; const wc = userProfile.winningCash || 0; const minW = appSettings?.minWithdraw || 50; elements.minWithdrawAmount.textContent = minW; elements.withdrawModalBalance.textContent = `₹${wc.toFixed(2)}`; elements.withdrawAmountInput.value = ''; elements.withdrawAmountInput.min = minW; elements.withdrawMethodInput.value = userProfile.upiId || ''; clearStatusMessage(elements.withdrawStatusMessage); elements.withdrawModalInstance.show(); }
        async function submitWithdrawRequestHandler() { if (!currentUser || !elements.withdrawModalInstance) return; const amt = parseFloat(elements.withdrawAmountInput.value); const mtd = elements.withdrawMethodInput.value.trim(); const wc = userProfile.winningCash || 0; const minW = appSettings?.minWithdraw || 50; clearStatusMessage(elements.withdrawStatusMessage); if (isNaN(amt) || amt <= 0) { showStatusMessage(elements.withdrawStatusMessage, 'Invalid amount.', 'warning'); return; } if (amt < minW) { showStatusMessage(elements.withdrawStatusMessage, `Min withdraw ₹${minW}.`, 'warning'); return; } if (amt > wc) { showStatusMessage(elements.withdrawStatusMessage, 'Insufficient winning balance.', 'warning'); return; } if (!mtd) { showStatusMessage(elements.withdrawStatusMessage, 'Enter withdrawal method.', 'warning'); return; } elements.submitWithdrawRequestBtn.disabled = true; elements.submitWithdrawRequestBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Sending...'; let transactionCommitted = false; try { const uRef = ref(db, `users/${currentUser.uid}`); const txResult = await runTransaction(uRef, (prof) => { if (prof) { if ((prof.winningCash || 0) >= amt) { prof.winningCash = (prof.winningCash || 0) - amt; return prof; } else { throw new Error("Insufficient winning balance (Tx)."); } } else { throw new Error("Profile missing (Tx)."); } }); if (!txResult.committed) { throw new Error("Failed to update balance. Please try again."); } transactionCommitted = true; const wrRef = ref(db, 'withdrawals'); const newReq = { userId: currentUser.uid, userName: userProfile.displayName || currentUser.email, amount: amt, methodDetails: { methodName: mtd.includes('@') ? 'UPI' : 'Bank/Other', accountInfo: mtd }, status: 'pending', requestTimestamp: serverTimestamp(), userEmail: currentUser.email || 'N/A' }; const newWithdrawalRef = await push(wrRef, newReq); await recordTransaction(currentUser.uid, 'withdraw_request', -amt, `Withdrawal Request to ${mtd}`, { withdrawalId: newWithdrawalRef.key }); showStatusMessage(elements.withdrawStatusMessage, 'Request submitted successfully!', 'success', false); setTimeout(() => { if (elements.withdrawModalInstance) elements.withdrawModalInstance.hide(); }, 2500); if (currentSectionId === 'wallet-section') loadRecentTransactions(); } catch (e) { console.error("Withdraw error:", e); showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}`, 'danger'); if (transactionCommitted) { const uRef = ref(db, `users/${currentUser.uid}`); try { await runTransaction(uRef, (prof) => { if (prof) { prof.winningCash = (prof.winningCash || 0) + amt; } return prof; }); await recordTransaction(currentUser.uid, 'withdraw_failed_refund', amt, `Refund Failed Withdrawal Request`); showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}. Amount refunded.`, 'danger'); } catch (refundError) { console.error("CRITICAL: FAILED TO REFUND WINNING CASH!", refundError); showStatusMessage(elements.withdrawStatusMessage, `Error: ${e.message}. CRITICAL: Failed to refund amount! Contact support.`, 'danger', false); } } } finally { elements.submitWithdrawRequestBtn.disabled = false; elements.submitWithdrawRequestBtn.innerHTML = 'Submit Request'; } }
        async function handleIdPasswordClick(event) { if (!elements.idPasswordModalInstance) return; const tId = event.currentTarget.dataset.tournamentId; if (!tId) return; if (!currentUser || !userProfile?.joinedTournaments?.[tId]) { showCustomAlert("Not Joined", "You must join the tournament first to view the Room ID & Password."); return; } elements.roomIdDisplay.innerHTML = '<span class="placeholder col-6"></span>'; elements.roomPasswordDisplay.innerHTML = '<span class="placeholder col-6"></span>'; elements.idPasswordModalInstance.show(); try { const tournamentRef = ref(db, `tournaments/${tId}`); const s = await get(tournamentRef); removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow')); removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow')); if (s.exists()) { const tournamentData = s.val(); if (tournamentData.showIdPass) { elements.roomIdDisplay.textContent = tournamentData.roomId || 'Not updated yet'; elements.roomPasswordDisplay.textContent = tournamentData.roomPass || 'Not updated yet'; } else { elements.roomIdDisplay.textContent = 'Hidden by Admin'; elements.roomPasswordDisplay.textContent = 'Hidden by Admin'; } } else { elements.roomIdDisplay.textContent = 'Not Found'; elements.roomPasswordDisplay.textContent = 'Not Found'; } } catch (e) { console.error("ID/Pass fetch error:", e); removePlaceholders(elements.roomIdDisplay.closest('.placeholder-glow')); removePlaceholders(elements.roomPasswordDisplay.closest('.placeholder-glow')); elements.roomIdDisplay.textContent = 'Error'; elements.roomPasswordDisplay.textContent = 'Error'; showCustomAlert("Error", "Could not load ID/Password. Check your network connection."); } }
        async function handlePolicyClick(event) { if (!elements.policyModalInstance) return; event.preventDefault(); const target = event.currentTarget; const policyType = target.dataset.policy; if (!policyType) return; let title = '', modalBodyContent = '<div class="text-center p-5"><div class="spinner-border spinner-border-sm"></div></div>'; elements.policyModalBody.innerHTML = modalBodyContent; switch (policyType) { case 'privacy': title = 'Privacy Policy'; modalBodyContent = appSettings.policyPrivacy || 'Content not available.'; break; case 'terms': title = 'Terms and Conditions'; modalBodyContent = appSettings.policyTerms || 'Content not available.'; break; case 'refund': title = 'Refund and Cancellation'; modalBodyContent = appSettings.policyRefund || 'Content not available.'; break; case 'fairPlay': title = 'Fair Play Policy'; modalBodyContent = appSettings.policyFairPlay || 'Content not available.'; break; case 'refer': title = 'Refer & Earn'; if (!currentUser) { showCustomAlert("Login Required", "Please log in to view your referral details."); return; } const refCode = userProfile.referralCode || 'N/A'; const refBonus = appSettings?.referralBonus || 0; const refDesc = appSettings?.referralDescription || `Get ₹${refBonus} when your friend joins using your code.`; modalBodyContent = `<div class="text-center"><h4>Refer Friends!</h4><p class="text-secondary">Share code & earn!</p><div class="my-4 p-3" style="background: var(--primary-bg); border-radius: 8px;"><p class="small text-secondary mb-1">Your Code:</p><h3 class="text-accent referral-code" id="referralCodeDisplay">${refCode}</h3><div class="mt-3"><button class="btn btn-sm btn-custom btn-custom-secondary me-2 copy-btn" data-target="#referralCodeDisplay"><i class="bi bi-clipboard"></i> Copy</button><button class="btn btn-sm btn-custom btn-custom-secondary" id="shareReferralBtn"><i class="bi bi-share-fill"></i> Share</button></div></div><p class="mt-3 small text-secondary">${refDesc}</p></div>`; break; default: title = 'Info'; modalBodyContent = '<p>Content unavailable.</p>'; } elements.policyModalTitle.textContent = title; if (typeof modalBodyContent === 'string' && policyType !== 'refer') { elements.policyModalBody.innerHTML = modalBodyContent.replace(/\n/g, '<br>'); } else { elements.policyModalBody.innerHTML = modalBodyContent; } elements.policyModalInstance.show(); }
        
        function setupRealtimeListeners(uid) {
            if (!uid || !db || !currentUser) return; detachAllDbListeners();
            const uRef = ref(db, `users/${uid}`);
            const listFunc = onValue(uRef, (s) => {
                if (currentUser && currentUser.uid === uid) {
                    if (s.exists()) {
                        const oldTimestamp = userProfile.lastCheckedNotifications; userProfile = s.val(); populateUserInfo(currentUser, userProfile); updateMyMatchesCounts();
                        if(oldTimestamp !== userProfile.lastCheckedNotifications) { setupNotificationListener(uid); }
                    } else { showCustomAlert("Account Error", "Your account data is missing or has been deleted. Logging you out."); logoutUser(); }
                } else { off(uRef, 'value', listFunc); }
            }, (e) => { console.error("Listener error (user profile):", e); });
            dbListeners['userProfile'] = { path: `users/${uid}`, func: listFunc };
            setupNotificationListener(uid);
        }
        function detachAllDbListeners() { let count = 0; for (const k in dbListeners) { try { const { path, func } = dbListeners[k]; if (path && func) { off(ref(db, path), 'value', func); count++; } } catch (e) { console.error(`Detach error ${k}:`, e); } } dbListeners = {}; console.log(`Detached ${count} listeners.`); }
        function setActiveTournamentTab(status) { if (!status || !elements.tournamentTabs) return; elements.tournamentTabs.forEach(tab => { tab.classList.toggle('active', tab.dataset.status.toLowerCase() === status.toLowerCase()); }); }

         function initializeEventListeners() {
             if (!elements) return;
             elements.bottomNavItems?.forEach(item => item.addEventListener('click', (e) => { e.preventDefault(); showSection(item.dataset.section); }));
             elements.headerBackBtn?.addEventListener('click', () => { if (currentSectionId === 'tournaments-section' || currentSectionId === 'tournament-details-section' || currentSectionId === 'earnings-history-section') { showSection(currentSectionId === 'earnings-history-section' ? 'earnings-section' : 'home-section'); } else if (currentSectionId === 'all-joinings-section') { if(lastTournamentDetailsId) showTournamentDetails(lastTournamentDetailsId); else showSection('tournaments-section'); } });
             elements.tournamentTabs?.forEach(tab => tab.addEventListener('click', (e) => { const s = e.currentTarget.dataset.status; if (s) { setActiveTournamentTab(s); filterTournaments(currentTournamentGameId, s, isShowingMyMatches); } }));
             elements.welcomeLoginBtn?.addEventListener('click', () => toggleLoginForm(true)); elements.welcomeCreateBtn?.addEventListener('click', () => toggleLoginForm(false));
             elements.authModalCloseBtn?.addEventListener('click', hideAuthModal); elements.authModalOverlay?.addEventListener('click', (e) => { if(e.target === elements.authModalOverlay) hideAuthModal(); });
             elements.loginEmailBtn?.addEventListener('click', loginWithEmail); elements.signupEmailBtn?.addEventListener('click', signUpWithEmail);
             elements.showSignupToggleBtn?.addEventListener('click', () => toggleLoginForm(false)); elements.showLoginToggleBtn?.addEventListener('click', () => toggleLoginForm(true));
             elements.forgotPasswordLink?.addEventListener('click', (e) => { e.preventDefault(); resetPassword(); });
             elements.logoutProfileBtn?.addEventListener('click', async () => {
                const confirmed = await showCustomConfirm('Logout', 'Are you sure you want to log out?');
                if (confirmed) {
                    logoutUser();
                }
             });
             elements.policyLinks?.forEach(link => link.addEventListener('click', handlePolicyClick));
             elements.policyLinksFooter?.forEach(link => link.addEventListener('click', handlePolicyClick));
             elements.notificationSwitch?.addEventListener('change', async (e) => {
                if (!currentUser) return;
                const isEnabled = e.target.checked;
                const userRef = ref(db, `users/${currentUser.uid}`);
                try {
                    await update(userRef, { notificationsEnabled: isEnabled });
                } catch (error) {
                    console.error("Failed to update notification settings:", error);
                    e.target.checked = !isEnabled; // Revert switch on error
                    showCustomAlert('Error', 'Could not save your setting. Please try again.');
                }
             });
             elements.withdrawBtn?.addEventListener('click', handleWithdrawClick);
             elements.addAmountWalletBtn?.addEventListener('click', () => { if (currentUser && elements.addAmountModalInstance) { if(elements.modalUserEmail) elements.modalUserEmail.textContent = currentUser.email || 'N/A'; elements.addAmountModalInstance.show(); } else if (!currentUser) { toggleLoginForm(true); } });
             elements.submitWithdrawRequestBtn?.addEventListener('click', submitWithdrawRequestHandler);
             
            elements.themeOptions?.forEach(option => {
                option.addEventListener('click', (e) => {
                    setTheme(e.currentTarget.dataset.theme);
                });
            });

             elements.notificationBtn?.addEventListener('click', () => toggleNotificationsPanel());
             elements.notificationPanelCloseBtn?.addEventListener('click', () => toggleNotificationsPanel(true));
             elements.allTransactionsBtn?.addEventListener('click', () => showCustomAlert('Coming Soon', 'The full transaction history page is under development.'));
             elements.viewEarningsHistoryBtn?.addEventListener('click', showEarningsHistory);
             querySelAll('.match-filter-btn').forEach(btn => { btn.addEventListener('click', (e) => { const status = e.currentTarget.dataset.status; loadMyMatchesView(status); }); });
             querySelAll('.game-type-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const clickedTab = e.currentTarget; const type = clickedTab.dataset.type;
                    querySelAll('.game-type-tab').forEach(t => t.classList.remove('active')); clickedTab.classList.add('active');
                    const gamesContentEl = getElement('gamesContent'); const challengesContentEl = getElement('challengesContent');
                    if (type === 'contests') { if (gamesContentEl) gamesContentEl.style.display = 'block'; if (challengesContentEl) challengesContentEl.style.display = 'none'; } else if (type === 'challenges') { if (gamesContentEl) gamesContentEl.style.display = 'none'; if (challengesContentEl) challengesContentEl.style.display = 'block'; }
                });
            });
             elements.customAlertOkBtn?.addEventListener('click', hideCustomAlert);
             document.body.addEventListener('click', (e) => { if (e.target.classList.contains('copy-btn')) { const targetSelector = e.target.closest('.copy-btn').dataset.target; copyToClipboard(targetSelector); } else if (e.target.id === 'shareReferralBtn') { const codeEl = document.getElementById('referralCodeDisplay'); if (codeEl) shareReferral(codeEl.textContent); } });
             
             document.addEventListener('DOMContentLoaded', async () => {
                initializeTheme();
                console.log("DOM Loaded. Initializing app...");
                showLoader(true);
                try { await loadAppSettings(); onAuthStateChanged(auth, handleAuthStateChange); } catch (error) { console.error("Initialization failed:", error); showCustomAlert("Init Failed", `A critical error occurred: ${error.message}`); showLoader(false); }
             });
         }
         initializeEventListeners();
    </script>
</body>

</html>